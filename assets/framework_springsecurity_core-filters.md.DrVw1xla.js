import{_ as i,o as a,c as t,a7 as n}from"./chunks/framework.CU6B6cvq.js";const g=JSON.parse('{"title":"æ ¸å¿ƒè¿‡æ»¤å™¨","description":"","frontmatter":{"title":"æ ¸å¿ƒè¿‡æ»¤å™¨","order":5,"category":["springsecurity"],"tag":["springsecurity"],"pageview":false,"date":"2023-11-15T23:44:03.000Z","comment":false,"breadcrumb":false},"headers":[],"relativePath":"framework/springsecurity/core-filters.md","filePath":"framework/springsecurity/core-filters.md"}'),e={name:"framework/springsecurity/core-filters.md"};function l(h,s,p,k,r,E){return a(),t("div",null,s[0]||(s[0]=[n(`<p><img src="https://gaoziman.oss-cn-hangzhou.aliyuncs.com/Leo100/202310302354916.png" alt="image-20231030235443828"></p><h2 id="_1-å‰è¨€" tabindex="-1">1.å‰è¨€ <a class="header-anchor" href="#_1-å‰è¨€" aria-label="Permalink to &quot;1.å‰è¨€&quot;">â€‹</a></h2><p>å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯Leoå“¥ğŸ«£ğŸ«£ğŸ«£ï¼Œä¸Šä¸€èŠ‚æˆ‘ä»¬é€šè¿‡æºç å‰–æä»¥åŠå›¾æ–‡åˆ†æï¼Œäº†è§£äº†å…³äº<code>å§”æ´¾ç­›é€‰å™¨ä»£ç†</code>å’Œ<code>è¿‡æ»¤å™¨é“¾ä»£ç†</code>çš„åŸç†å’Œä½œç”¨ã€‚è¿™èŠ‚è¯¾æˆ‘ä»¬æ¥ç€å­¦ä¹ SpringSecurityçš„è¿‡æ»¤å™¨ï¼Œäº†è§£SpringSecurityä¸­éƒ½æœ‰å“ªäº›æ ¸å¿ƒè¿‡æ»¤å™¨ã€‚å¥½äº†ï¼Œè¯ä¸å¤šè¯´è®©æˆ‘ä»¬å¼€å§‹å§ğŸ˜ğŸ˜ğŸ˜ã€‚</p><h2 id="_2-å‰æçŸ¥è¯†" tabindex="-1">2.å‰æçŸ¥è¯† <a class="header-anchor" href="#_2-å‰æçŸ¥è¯†" aria-label="Permalink to &quot;2.å‰æçŸ¥è¯†&quot;">â€‹</a></h2><p>ä¸Šä¸€èŠ‚ä¸­æˆ‘ä»¬è¯¦ç»†çš„å‰–æäº†å§”æ´¾ç­›é€‰å™¨ä»£ç†---&gt;<strong>DelegatingFilterProxy</strong>,å®ƒçš„ä½œç”¨å°±æ˜¯ï¼šå®ç°æŠŠServletå®¹å™¨ä¸­çš„ Filter åŒ Spring å®¹å™¨ä¸­çš„ bean å…³è”èµ·æ¥ï¼Œ<code>DelegatingFilterProxy</code>å®ç°äº†Filteræ¥å£ï¼ŒServletå®¹å™¨å¯åŠ¨å°±ä¼šåŠ è½½å¥½è¿™ä¸ªç±»ã€‚å€ŸåŠ©ä»–å¯ä»¥å®ç°æ™®é€šçš„Filteræ‹¦æˆªåˆ°çš„Httpè¯·æ±‚äº¤ç”±FilterChainProxyã€‚</p><p><code>FilterChainProxy</code> æ˜¯<strong>é¡¶å±‚ç®¡ç†è€…</strong>ï¼Œç»Ÿä¸€ç®¡ç† SecurityFilterå’Œ SecurityFllterChainè¿‡æ»¤å™¨é“¾</p><p>å½“è¯·æ±‚åˆ°è¾¾ FilterChainProxy æ—¶ï¼Œä¼šæ ¹æ®å½“å‰è¯·æ±‚åŒ¹é…SecurityFilterChainï¼Œç„¶åå°†è¯·æ±‚ä¾æ¬¡è½¬å‘ç»™ SecurityFilterChain ä¸­çš„ SecurityFilterä¸­ã€‚</p><p>å›åˆ°æˆ‘ä»¬ä¸Šä¸€å¼ åˆ†æå›¾ã€‚</p><p><img src="https://gaoziman.oss-cn-hangzhou.aliyuncs.com/Leo100/202311072047866.png" alt="image-20231107204747766"></p><p>å¤§å®¶å¯ä»¥å†æ¬¡æ¢³ç†ä¸€ä¸‹å½“ä¸€ä¸ªHttpè¯·æ±‚å‘å‡ºç›´åˆ°è·å–Webèµ„æºçš„æ•´ä¸ªè¿‡ç¨‹ã€‚</p><h2 id="_3-æ ¸å¿ƒè¿‡æ»¤å™¨" tabindex="-1">3.æ ¸å¿ƒè¿‡æ»¤å™¨ <a class="header-anchor" href="#_3-æ ¸å¿ƒè¿‡æ»¤å™¨" aria-label="Permalink to &quot;3.æ ¸å¿ƒè¿‡æ»¤å™¨&quot;">â€‹</a></h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¸»è¦ä»‹ç»<code>Spring Security</code>ä¸­é»˜è®¤çš„<code>15</code>ä¸ªè¿‡æ»¤å™¨ç›¸å…³ä½œç”¨ã€‚</p><p>è¿™ä¸ªæ—¶å€™æœ‰äººé—®å•¦ï¼ŒLeoå“¥ï¼Œä½ æ€ä¹ˆçŸ¥é“SpringSecurityé»˜è®¤æ˜¯15ä¸ªæ ¸å¿ƒè¿‡æ»¤å™¨å‘¢ï¼Œä¸ºå•¥ä¸æ˜¯14ä¸ªã€‚</p><p>å“ˆå“ˆå“ˆï¼Œè¿™ä¸ªé—®é¢˜é—®å¾—å¥½ï¼Œæ—¢ç„¶æˆ‘æ•¢è¿™ä¹ˆè¯´ï¼Œé‚£ä¸€å®šæ˜¯æœ‰æŠŠæ¡å•¦ï¼Œä¸‹é¢æˆ‘ä»¬å¯åŠ¨IDEAçœ‹çœ‹ã€‚</p><p>æ‰“å¼€IDEAï¼Œæœç´¢<strong>WebSecurityConfiguration</strong>è¿™ä¸ªæ€»é…ç½®ç±»</p><p><img src="https://gaoziman.oss-cn-hangzhou.aliyuncs.com/Leo100/202311072355165.png" alt="image-20231107235513951"></p><p>å¹¶åœ¨è¿™é‡Œæ‰“ä¸€ä¸ªæ–­ç‚¹ï¼Œä¹‹åé‡å¯IDEAï¼Œè®°å¾—ä»¥DEBUGæ–¹å¼è¿è¡Œã€‚</p><p><img src="https://gaoziman.oss-cn-hangzhou.aliyuncs.com/Leo100/202311072356914.png" alt="image-20231107235650717"></p><p>æˆ‘ä»¬é¼ æ ‡æ”¾åœ¨è¿™ä¸€è¡Œè¿›è¡ŒæŸ¥çœ‹ï¼Œç¡®å®æ˜¯é¡¹ç›®å·²å¯åŠ¨å°±åŠ è½½äº†è¿™ä¸ª15ä¸ªè¿‡æ»¤å™¨ã€‚å˜¿å˜¿ã€‚</p><h3 id="_3-1disableencodeurlfilter" tabindex="-1">3.1DisableEncodeUrlFilter <a class="header-anchor" href="#_3-1disableencodeurlfilter" aria-label="Permalink to &quot;3.1DisableEncodeUrlFilter&quot;">â€‹</a></h3><p>è¯¥è¿‡æ»¤å™¨ç”¨äºç¦ç”¨å¯¹URLè¿›è¡Œç¼–ç çš„åŠŸèƒ½ã€‚å®ƒçš„ä½œç”¨æ˜¯é˜»æ­¢Spring Securityå¯¹URLè¿›è¡Œè‡ªåŠ¨ç¼–ç ï¼Œä»è€Œä½¿å¾—URLå¯ä»¥ä¿æŒåŸå§‹çŠ¶æ€ã€‚</p><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯èƒ½å¸Œæœ›ç¦ç”¨Spring Securityå¯¹URLçš„ç¼–ç ï¼Œä¾‹å¦‚åœ¨ç‰¹å®šçš„ä»£ç†æœåŠ¡å™¨æˆ–åå‘ä»£ç†æœåŠ¡å™¨ä¸Šï¼Œå› ä¸ºè¿™äº›ä»£ç†æœåŠ¡å™¨å¯èƒ½ä¼šè‡ªå·±å¤„ç†URLçš„ç¼–ç ã€‚æ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨ <code>DisableEncodeUrlFilter</code> æ¥ç¦ç”¨Spring Securityå¯¹URLçš„ç¼–ç ã€‚</p><p>å½“ä½ åœ¨Spring Securityé…ç½®ä¸­åŠ å…¥ <code>DisableEncodeUrlFilter</code> æ—¶ï¼Œå®ƒå°†ä¼šåœ¨è¿‡æ»¤å™¨é“¾ä¸­èµ·ä½œç”¨ï¼Œç¦æ­¢Spring Securityå¯¹URLè¿›è¡Œç¼–ç ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒä¼šè¦†ç›–é»˜è®¤çš„ <code>DefaultSecurityFilterChain</code> é…ç½®ï¼Œä»¥ç¡®ä¿ URL ç¼–ç è¢«ç¦ç”¨ã€‚</p><p><strong>åœ¨XMLé…ç½®ä¸­å¦‚ä¸‹æ‰€ç¤º:</strong></p><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">beans:bean</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;disableUrlEncodingFilter&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;org.springframework.security.web.servletapi.DisableEncodeUrlFilter&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">intercept-url</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> pattern</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/somepattern&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> access</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;permitAll&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">custom-filter</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ref</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;disableUrlEncodingFilter&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> before</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;SECURITY_CONTEXT_FILTER&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre></div><p><strong>åœ¨Javaé…ç½®ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤º:</strong></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SecurityFilterChain </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filterChain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpSecurity http) throws Exception {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> http</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authorizeRequests</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">antMatchers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/somepattern&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">permitAll</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // æ·»åŠ  DisableEncodeUrlFilter åˆ°è¿‡æ»¤å™¨é“¾ä¸­</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">and</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addFilterBefore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DisableEncodeUrlFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), SecurityContextPersistenceFilter.class);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>è¿™ä¸ªè¿‡æ»¤å™¨æœ‰ä»€ä¹ˆç”¨ï¼Ÿ é¦–å…ˆå®ç°<code>Session</code>ä¼šè¯ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼</p><ul><li><strong>Cookie</strong>ï¼šæµè§ˆå™¨è®¾ç½®ï¼Œæ¯æ¬¡è¯·æ±‚è‡ªåŠ¨æºå¸¦ç»™æœåŠ¡ç«¯</li><li><strong>URLé‡å†™</strong>ï¼š<code>Cookie</code>è¢«ç¦ç”¨æ—¶ï¼Œåç«¯å“åº”å°†<code>sessionId</code>æ‹¼æ¥åœ¨<code>URL</code>åè¿›è¡Œé‡å†™ï¼Œä¼ é€’ç»™é¡µé¢</li></ul><p><code>DisableEncodeUrlFilter</code>ç¦ç”¨<code>HttpServletResponse</code>å¯¹<code>URL</code>è¿›è¡Œç¼–ç é‡å†™ï¼Œä»¥é˜²æ­¢å°†<code>sessionId</code>åœ¨<code>HTTP</code>è®¿é—®æ—¥å¿—ç­‰å†…å®¹ä¸­æ³„éœ²ã€‚</p><p><code>DisableEncodeUrlResponseWrapper</code>ï¼Œæˆ‘ä»¬æ¥ç®€å•æ¥ä¸€ä¸‹ä»–çš„æºç ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DisableEncodeUrlResponseWrapper</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HttpServletResponseWrapper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        private</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DisableEncodeUrlResponseWrapper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpServletResponse </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            super</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(response);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// ç›´æ¥è¿”å›ï¼Œä¸é‡å†™</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">encodeRedirectURL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> url;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// ç›´æ¥è¿”å›ï¼Œä¸é‡å†™</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">encodeURL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> url;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span></code></pre></div><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶ç¦ç”¨URLç¼–ç å¯èƒ½åœ¨ç‰¹å®šçš„æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ï¼Œä½†è¿™ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›å®‰å…¨æ€§é—®é¢˜ï¼Œå› ä¸ºURLç¼–ç é€šå¸¸æ˜¯ä¸ºäº†<strong>é˜²æ­¢è·¨ç«™è„šæœ¬ï¼ˆXSSï¼‰æ”»å‡»</strong>ç­‰å®‰å…¨é—®é¢˜ã€‚å› æ­¤ï¼Œç¦ç”¨URLç¼–ç åº”è¯¥æ…é‡è€ƒè™‘ï¼Œå¹¶ä¸”éœ€è¦åœ¨å……åˆ†äº†è§£å…¶æ½œåœ¨é£é™©çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚</p><h3 id="_3-2webasyncmanagerintegrationfilter" tabindex="-1">3.2WebAsyncManagerIntegrationFilter <a class="header-anchor" href="#_3-2webasyncmanagerintegrationfilter" aria-label="Permalink to &quot;3.2WebAsyncManagerIntegrationFilter&quot;">â€‹</a></h3><p><code>WebAsyncManagerIntegrationFilter</code>ç”¨äºé›†æˆ<strong>Webå¼‚æ­¥ç®¡ç†å™¨(WebAsyncManager)</strong>ã€‚å®ƒåœ¨å¤„ç†å¼‚æ­¥è¯·æ±‚æ—¶èµ·ç€é‡è¦çš„ä½œç”¨ï¼Œå¹¶ç¡®ä¿åœ¨å¼‚æ­¥å¤„ç†è¿‡ç¨‹ä¸­æ­£ç¡®åœ°ç®¡ç†å®‰å…¨ä¸Šä¸‹æ–‡ã€‚</p><p><code>WebAsyncManagerIntegrationFilter</code>æ˜¯ç¬¬äºŒä¸ªæ‰§è¡Œçš„è¿‡æ»¤å™¨ï¼Œä»åå­—ä¸Šå¯ä»¥çŸ¥é“å’Œå¼‚å¸¸è¯·æ±‚æœ‰å…³ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œ<code>WebAsyncManagerIntegrationFilter</code>è´Ÿè´£åœ¨å¼‚æ­¥å¤„ç†è¿‡ç¨‹ä¸­åŒæ­¥å®‰å…¨ä¸Šä¸‹æ–‡ï¼Œä»¥ç¡®ä¿å®‰å…¨ä¸Šä¸‹æ–‡èƒ½å¤Ÿæ­£ç¡®ä¼ æ’­åˆ°å¼‚æ­¥æ‰§è¡Œçš„çº¿ç¨‹ä¸­ã€‚è¿™å¯¹äºå¤„ç†å¼‚æ­¥è¯·æ±‚éå¸¸é‡è¦ï¼Œå› ä¸ºåœ¨å¼‚æ­¥å¤„ç†ä¸­ï¼Œçº¿ç¨‹å¯èƒ½ä¼šå‘ç”Ÿåˆ‡æ¢ï¼Œè€Œå®‰å…¨ä¸Šä¸‹æ–‡çš„æ­£ç¡®ä¼ é€’å¯¹äºå®‰å…¨æ“ä½œè‡³å…³é‡è¦ã€‚</p><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œ<code>WebAsyncManagerIntegrationFilter</code>é€šå¸¸ä¸Spring MVCçš„å¼‚æ­¥è¯·æ±‚å¤„ç†æœºåˆ¶ä¸€èµ·ä½¿ç”¨ï¼Œç¡®ä¿åœ¨ä½¿ç”¨<code>Callable</code>æˆ–<code>DeferredResult</code>ç­‰å¼‚æ­¥å¤„ç†æ–¹å¼æ—¶ï¼Œå®‰å…¨ä¸Šä¸‹æ–‡èƒ½å¤Ÿæ­£ç¡®ä¼ æ’­ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>Spring Security </code>ç»è¿‡è®¤è¯åï¼Œè®¤è¯ä¿¡æ¯ä¼šå­˜å‚¨åœ¨å½“å‰çº¿ç¨‹<code>ThreadLocal</code>ï¼ˆä¸æ˜¯<code>InheritableThreadLocal</code>ï¼‰ä¸­ï¼Œå¦‚æœæ˜¯å¼‚æ­¥ï¼Œä¸»çº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œå­çº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ™æ— æ³•è·å–å½“å‰è®¤è¯ä¿¡æ¯ã€‚</p><p>åœ¨<code>Spring </code>ä¸­çš„å¼‚æ­¥é€šè¿‡<code>WebAsyncManager</code>ç®¡ç†å¼‚æ­¥è¯·æ±‚ï¼Œå¼‚æ­¥è¯·æ±‚äº¤ç”±<code>TaskExecutor</code>çº¿ç¨‹æ± å»å¤„ç†ï¼Œ<code>WebAsyncManager</code>æä¾›äº†ä¸€ä¸ªæ‹¦æˆªå™¨æœºåˆ¶ï¼Œå¯ä»¥ç”¨æ‹¦æˆªå™¨å°†ä¸»çº¿ç¨‹ä¸­çš„æ•°æ®ä¼ é€’åˆ°å­çº¿ç¨‹ä¸­ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œæ¼”ç¤ºäº†å¦‚ä½•åœ¨SpringSecurityé…ç½®ä¸­ä½¿ç”¨WebAsyncManagerIntegrationFilterï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SecurityFilterChain </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filterChain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpSecurity http) throws Exception {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> http</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             // ...å…¶ä»–é…ç½®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> WebAsyncManagerIntegrationFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ·»åŠ WebAsyncManagerIntegrationFilteråˆ°è¿‡æ»¤å™¨é“¾ä¸­</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // ...å…¶ä»–é…ç½®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒWebAsyncManagerIntegrationFilteré€šå¸¸ä¸éœ€è¦æ˜¾å¼åœ°åœ¨é…ç½®ä¸­æ·»åŠ ï¼Œå› ä¸ºå®ƒé€šå¸¸ä¼šç”±Spring Securityè‡ªåŠ¨æ·»åŠ åˆ°è¿‡æ»¤å™¨é“¾ä¸­ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ æœ‰ç‰¹æ®Šçš„éœ€æ±‚æˆ–è€…å®šåˆ¶åŒ–çš„å¼‚æ­¥å¤„ç†æ–¹å¼ï¼Œä½ å¯èƒ½éœ€è¦æ˜¾å¼åœ°æ·»åŠ WebAsyncManagerIntegrationFilterã€‚</p><p>æ€»ä¹‹ï¼ŒWebAsyncManagerIntegrationFilteråœ¨SpringSecurityä¸­æ‰®æ¼”ç€ç¡®ä¿å®‰å…¨ä¸Šä¸‹æ–‡æ­£ç¡®ä¼ æ’­åˆ°å¼‚æ­¥å¤„ç†è¿‡ç¨‹ä¸­çš„é‡è¦è§’è‰²ï¼Œå®ƒæ˜¯ä¿è¯å¼‚æ­¥è¯·æ±‚å¤„ç†å®‰å…¨æ€§çš„å…³é”®ç»„æˆéƒ¨åˆ†ã€‚</p><h3 id="_3-3headerwriterfilter" tabindex="-1">3.3HeaderWriterFilter <a class="header-anchor" href="#_3-3headerwriterfilter" aria-label="Permalink to &quot;3.3HeaderWriterFilter&quot;">â€‹</a></h3><p><code>HeaderWriterFilter</code>å­—é¢ç†è§£ä¸ºè¯·æ±‚å¤´å†™å…¥è¿‡æ»¤å™¨ï¼Œä»–çš„ä½œç”¨æ˜¯å°†æŸäº›å¤´ä¿¡æ¯æ·»åŠ åˆ°å“åº”ä¸­ï¼Œæ·»åŠ æŸäº›å¯ç”¨æµè§ˆå™¨ä¿æŠ¤çš„å¤´ä¿¡æ¯éå¸¸æœ‰ç”¨ï¼Œå¦‚<code>X-Frame-Options</code>ã€<code>X-XSS-Protection</code>ã€<code>X-Content-Type-Options</code>ç­‰ï¼Œå¢åŠ ä¸€äº›å®‰å…¨æ€§ã€‚</p><p>é€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æ·»åŠ å¤´éƒ¨ä¿¡æ¯ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> doFilterInternal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    	// shouldWriteHeadersEagerly ç›´æ¥æ·»åŠ </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.shouldWriteHeadersEagerly) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doHeadersBefore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response, filterChain);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doHeadersAfter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response, filterChain);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span></code></pre></div><p>å…·ä½“æ¥è¯´ï¼Œ<code>SecurityContextHolderFilter</code> é€šè¿‡ <code>SecurityContextHolder</code> æ¥ç®¡ç†å®‰å…¨ä¸Šä¸‹æ–‡ã€‚<code>SecurityContextHolder</code> æ˜¯ Spring Security æä¾›çš„ä¸€ä¸ªæŒæœ‰å®‰å…¨ä¸Šä¸‹æ–‡çš„åœ°æ–¹ï¼Œå®ƒä½¿ç”¨ <code>ThreadLocal</code> æ¥ç¡®ä¿åœ¨åŒä¸€çº¿ç¨‹å†…å®‰å…¨ä¸Šä¸‹æ–‡çš„ä¼ é€’ã€‚</p><p>åœ¨è¯·æ±‚åˆ°è¾¾åç«¯åº”ç”¨ç¨‹åºæ—¶ï¼Œ<code>SecurityContextHolderFilter</code> å°†å½“å‰çš„å®‰å…¨ä¸Šä¸‹æ–‡ä¿¡æ¯ä» HTTP è¯·æ±‚ä¸­è·å–ï¼Œå¹¶å­˜å‚¨åœ¨ <code>SecurityContextHolder</code> ä¸­ã€‚è¿™æ ·ï¼Œåœ¨è¯·æ±‚çš„ä»»ä½•åœ°æ–¹ï¼Œéƒ½å¯ä»¥é€šè¿‡ <code>SecurityContextHolder</code> æ¥è·å–å½“å‰ç”¨æˆ·çš„èº«ä»½ã€æƒé™ç­‰å®‰å…¨ä¿¡æ¯ã€‚</p><p>åœ¨ <strong>SpringSecurity</strong> é…ç½®ä¸­ï¼Œé€šå¸¸ä¼šè‡ªåŠ¨åŒ…å« <code>SecurityContextHolderFilter</code>ï¼Œå› æ­¤åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ä¸éœ€è¦æ˜¾å¼åœ°é…ç½®è¯¥è¿‡æ»¤å™¨ã€‚ä¾‹å¦‚ï¼Œåœ¨åŸºäº Java çš„é…ç½®ä¸­ï¼Œä½ é€šå¸¸åªéœ€è¦é€šè¿‡ <code>@EnableWebSecurity</code> æ³¨è§£å¯ç”¨ Spring Securityï¼Œå¹¶è¿›è¡Œç›¸åº”çš„é…ç½®å³å¯ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œæ¼”ç¤ºäº†å¦‚ä½•åœ¨ Spring Security ä¸­è¿›è¡ŒåŸºæœ¬çš„é…ç½®ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SecurityFilterChain </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filterChain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpSecurity http) throws Exception {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> http</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // ...å…¶ä»–é…ç½®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authorizeRequests</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">anyRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authenticated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">and</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">formLogin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">and</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">httpBasic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>åœ¨è¿™ä¸ªé…ç½®ä¸­ï¼Œè™½ç„¶æ²¡æœ‰æ˜¾å¼åœ°æ·»åŠ  <code>SecurityContextHolderFilter</code>ï¼Œä½†å®ƒä¼šè¢«è‡ªåŠ¨åŒ…å«åœ¨ Spring Security çš„è¿‡æ»¤å™¨é“¾ä¸­ã€‚</p><p>æ€»ä¹‹ï¼Œ<code>SecurityContextHolderFilter</code> åœ¨ Spring Security ä¸­æ‰®æ¼”ç€ç¡®ä¿å®‰å…¨ä¸Šä¸‹æ–‡æ­£ç¡®ä¼ æ’­å’Œç®¡ç†çš„é‡è¦è§’è‰²ï¼Œå®ƒæ˜¯æ•´ä¸ªå®‰å…¨æ¡†æ¶ä¸­çš„å…³é”®ç»„æˆéƒ¨åˆ†ã€‚</p><h3 id="_3-4csrffilter" tabindex="-1">3.4CsrfFilter <a class="header-anchor" href="#_3-4csrffilter" aria-label="Permalink to &quot;3.4CsrfFilter&quot;">â€‹</a></h3><p><code>CsrfFilter</code> æ˜¯SpringSecurity ä¸­ç”¨äºé˜²æ­¢ **CSRF(è·¨ç«™è¯·æ±‚ä¼ªé€ )**æ”»å‡»çš„è¿‡æ»¤å™¨ã€‚CSRF æ”»å‡»æ˜¯ä¸€ç§åˆ©ç”¨ç”¨æˆ·åœ¨å…¶ä»–ç½‘ç«™ä¸Šå·²ç»ç™»å½•çš„èº«ä»½ä¿¡æ¯ï¼Œæ¥å‘èµ·å¯¹ç›®æ ‡ç½‘ç«™çš„æ¶æ„è¯·æ±‚çš„æ”»å‡»æ–¹å¼ã€‚ä¸ºäº†é˜²æ­¢è¿™ç§æ”»å‡»ï¼ŒSpringSecurity æä¾›äº† <code>CsrfFilter</code> æ¥åŠ å¼ºåº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§ã€‚</p><p><code>CsrfFilter</code> çš„ä¸»è¦ä½œç”¨æ˜¯éªŒè¯æ¯ä¸ªéå®‰å…¨ HTTP è¯·æ±‚ï¼ˆä¾‹å¦‚ POSTã€PUTã€DELETE ç­‰ï¼‰ä¸­æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„ CSRF ä»¤ç‰Œã€‚å¦‚æœè¯·æ±‚ä¸­ç¼ºå°‘æœ‰æ•ˆçš„ CSRF ä»¤ç‰Œï¼Œ<code>CsrfFilter</code> å°†æ‹’ç»è¯¥è¯·æ±‚ï¼Œå¹¶è¿”å›ç›¸åº”çš„é”™è¯¯ä¿¡æ¯ã€‚</p><p>åœ¨ Spring Security ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>CsrfFilter</code> æ˜¯è‡ªåŠ¨å¯ç”¨çš„ï¼Œå®ƒä¼šåœ¨è¯·æ±‚ä¸­è‡ªåŠ¨æ·»åŠ  CSRF ä»¤ç‰Œï¼Œå¹¶éªŒè¯æ¯ä¸ªéå®‰å…¨è¯·æ±‚ä¸­çš„ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆã€‚åŒæ—¶ï¼ŒSpring Security è¿˜æä¾›äº†ä¸€äº›é…ç½®é€‰é¡¹ï¼Œä»¥ä¾¿å¼€å‘äººå‘˜å¯ä»¥æ ¹æ®åº”ç”¨ç¨‹åºçš„éœ€æ±‚è¿›è¡Œå®šåˆ¶åŒ–çš„ CSRF é˜²æŠ¤ç­–ç•¥ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œæ¼”ç¤ºäº†å¦‚ä½•åœ¨ SpringSecurity ä¸­è¿›è¡ŒåŸºæœ¬çš„ <strong>CSRF</strong> é…ç½®ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SecurityFilterChain </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filterChain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpSecurity http) throws Exception {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> http</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             // ...å…¶ä»–é…ç½®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">csrf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">disable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç¦ç”¨ CSRF é˜²æŠ¤</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>åœ¨è¿™ä¸ªé…ç½®ä¸­ï¼Œé€šè¿‡ç¦ç”¨<strong>CSRF</strong>é˜²æŠ¤ï¼Œ<code>CsrfFilter</code> å°†ä¸å†ç”Ÿæ•ˆï¼Œä»è€Œå…è®¸éå®‰å…¨è¯·æ±‚ä¸æºå¸¦ CSRF ä»¤ç‰Œã€‚</p><p>æ€»ä¹‹ï¼Œ<code>CsrfFilter</code> åœ¨ SpringSecurity ä¸­æ‰®æ¼”ç€åŠ å¼ºåº”ç”¨ç¨‹åºå®‰å…¨æ€§çš„é‡è¦è§’è‰²ï¼Œå®ƒæ˜¯ä¿æŠ¤åº”ç”¨ç¨‹åºå…å— CSRF æ”»å‡»çš„å…³é”®ç»„æˆéƒ¨åˆ†ã€‚é€šè¿‡åˆç†åœ°é…ç½®å’Œä½¿ç”¨ <code>CsrfFilter</code>ï¼Œå¯ä»¥æœ‰æ•ˆåœ°æé«˜åº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§ã€‚</p><h3 id="_3-5securitycontextholderfilter" tabindex="-1">3.5SecurityContextHolderFilter <a class="header-anchor" href="#_3-5securitycontextholderfilter" aria-label="Permalink to &quot;3.5SecurityContextHolderFilter&quot;">â€‹</a></h3><p><code>SecurityContextHolderFilter</code>æ˜¯ç¬¬äº”ä¸ªè¿‡æ»¤å™¨ï¼Œç›´æ¥ç»§æ‰¿è‡ª<code>GenericFilterBean</code>ï¼Œå£°æ˜äº†ä¸¤ä¸ªæˆå‘˜å±æ€§ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	// è¯·æ±‚ä¹‹é—´æŒä¹…åŒ–	 SecurityContext</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SecurityContextRepository securityContextRepository;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	// ä¸€ç§é’ˆå¯¹çº¿ç¨‹å­˜å‚¨ SecurityContext ç­–ç•¥ã€‚</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SecurityContextHolderStrategy securityContextHolderStrategy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SecurityContextHolder</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getContextHolderStrategy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><p>ä¸éš¾çœ‹å‡ºï¼Œè¯¥è¿‡æ»¤å™¨çš„ä½œç”¨å°±æ˜¯å°†æŒä¹…åŒ–çš„<code>SecurityContext</code>è®¾ç½®åˆ°å½“å‰çº¿ç¨‹ä¸­ï¼Œæ¯”å¦‚ç™»å½•æˆåŠŸåï¼Œåœ¨<code>HttpSession</code>ä¸­ä¿å­˜äº†<code>SecurityContext</code>ï¼Œé‚£ä¹ˆè¯¥è¿‡æ»¤å™¨å¯ä»¥ç›´æ¥å°†<code>SecurityContext</code>è®¾ç½®åˆ°è¯·æ±‚çº¿ç¨‹ä¸­ã€‚</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			throws ServletException, IOException {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 1. è·å–å±æ€§ SecurityContextHolderFilter.class.getName() + &quot;.APPLIED&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// å­˜åœ¨è¯´æ˜å½“å‰è¯·æ±‚å·²æ‰§è¡Œè¯¥è¿‡æ»¤å™¨</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (request.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getAttribute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(FILTER_APPLIED) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			chain.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 2. è®¾ç½®å±æ€§</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		request.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setAttribute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(FILTER_APPLIED, Boolean.TRUE);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 3. å­˜å‚¨ä¸­åŠ è½½ SecurityContext</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		Supplier&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SecurityContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; deferredContext </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.securityContextRepository.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">loadDeferredContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 4. å°†SecurityContext è®¾ç½®åˆ°ContextHolderä¸­</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">			this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.securityContextHolderStrategy.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setDeferredContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(deferredContext);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			chain.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// å®Œæˆåï¼Œæ¸…ç†ä¸Šä¸‹æ–‡ï¼Œç§»é™¤å±æ€§</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">			this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.securityContextHolderStrategy.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clearContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			request.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">removeAttribute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(FILTER_APPLIED);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span></code></pre></div><p><code>SecurityContextHolderFilter</code> è´Ÿè´£åœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­ç®¡ç†å®‰å…¨ä¸Šä¸‹æ–‡ã€‚å®‰å…¨ä¸Šä¸‹æ–‡æ˜¯æŒ‡å­˜å‚¨äº†å½“å‰ç”¨æˆ·çš„è®¤è¯ä¿¡æ¯ï¼ˆå¦‚èº«ä»½ã€æƒé™ç­‰ï¼‰çš„å¯¹è±¡ï¼Œåœ¨æ•´ä¸ªè¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­éœ€è¦è¢«ä½¿ç”¨ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œ<code>SecurityContextHolderFilter</code> ä¸»è¦å®Œæˆä»¥ä¸‹å‡ ä¸ªä»»åŠ¡ï¼š</p><ol><li>ä»è¯·æ±‚ä¸­è·å–å®‰å…¨ä¸Šä¸‹æ–‡ï¼šå½“è¯·æ±‚åˆ°è¾¾åç«¯åº”ç”¨ç¨‹åºæ—¶ï¼Œ<code>SecurityContextHolderFilter</code> ä¼šå°è¯•ä»è¯·æ±‚ä¸­æå–å®‰å…¨ç›¸å…³çš„ä¿¡æ¯ï¼Œä¾‹å¦‚è®¤è¯å‡­è¯ã€æƒé™ä¿¡æ¯ç­‰ã€‚</li><li>å°†å®‰å…¨ä¸Šä¸‹æ–‡ä¸å½“å‰çº¿ç¨‹ç»‘å®šï¼šè·å–åˆ°å®‰å…¨ä¸Šä¸‹æ–‡åï¼Œ<code>SecurityContextHolderFilter</code> ä¼šå°†å…¶ç»‘å®šåˆ°å½“å‰çº¿ç¨‹ä¸­ã€‚Spring Security ä½¿ç”¨ <code>ThreadLocal</code> æ¥å®ç°çº¿ç¨‹æœ¬åœ°å˜é‡å­˜å‚¨ï¼Œç¡®ä¿åœ¨åŒä¸€çº¿ç¨‹å†…å®‰å…¨ä¸Šä¸‹æ–‡çš„ä¼ é€’ã€‚</li><li>å…è®¸åœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­è®¿é—®å®‰å…¨ä¸Šä¸‹æ–‡ï¼šä¸€æ—¦å®‰å…¨ä¸Šä¸‹æ–‡ä¸å½“å‰çº¿ç¨‹ç»‘å®šæˆåŠŸï¼Œæ•´ä¸ªè¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­çš„ä»£ç å‡å¯é€šè¿‡ <code>SecurityContextHolder</code> æ¥è·å–å½“å‰ç”¨æˆ·çš„å®‰å…¨ä¿¡æ¯ï¼Œè€Œæ— éœ€æ˜¾å¼åœ°ä¼ é€’å®‰å…¨ä¸Šä¸‹æ–‡ã€‚</li></ol><p>åœ¨å…¸å‹çš„SpringSecurity é…ç½®ä¸­ï¼Œ<code>SecurityContextHolderFilter</code> é€šå¸¸ä½œä¸ºè¿‡æ»¤å™¨é“¾ä¸­çš„ç¬¬ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œä»¥ç¡®ä¿åœ¨è¯·æ±‚è¿›å…¥åº”ç”¨ç¨‹åºæ—¶ï¼Œå®‰å…¨ä¸Šä¸‹æ–‡å·²ç»å‡†å¤‡å°±ç»ªã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨<strong>SpringSecurity</strong> ä¸­è¿›è¡ŒåŸºæœ¬çš„é…ç½®ï¼Œå¹¶æ¼”ç¤ºäº† <code>SecurityContextHolderFilter</code> çš„ä½¿ç”¨ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SecurityFilterChain </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filterChain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpSecurity http) throws Exception {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> http</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             // ...å…¶ä»–é…ç½®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addFilterBefore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SecurityContextHolderFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), UsernamePasswordAuthenticationFilter.class)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authorizeRequests</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">anyRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authenticated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">and</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">formLogin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>åœ¨è¿™ä¸ªé…ç½®ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>addFilterBefore</code> æ–¹æ³•å°†è‡ªå®šä¹‰çš„ <code>SecurityContextHolderFilter</code> æ·»åŠ åˆ°äº†è¿‡æ»¤å™¨é“¾ä¸­ï¼Œä»¥ç¡®ä¿åœ¨è¯·æ±‚è¿›å…¥åº”ç”¨ç¨‹åºæ—¶èƒ½å¤Ÿæ­£ç¡®å¤„ç†å®‰å…¨ä¸Šä¸‹æ–‡ã€‚</p><p>æ€»ä¹‹ï¼Œ<code>SecurityContextHolderFilter</code> åœ¨ Spring Security ä¸­æ‰®æ¼”ç€ç¡®ä¿å®‰å…¨ä¸Šä¸‹æ–‡æ­£ç¡®ä¼ æ’­å’Œç®¡ç†çš„é‡è¦è§’è‰²ï¼Œå®ƒæ˜¯æ•´ä¸ªå®‰å…¨æ¡†æ¶ä¸­çš„å…³é”®ç»„æˆéƒ¨åˆ†ã€‚é€šè¿‡åˆç†åœ°é…ç½®å’Œä½¿ç”¨ <code>SecurityContextHolderFilter</code>ï¼Œå¯ä»¥ç¡®ä¿å®‰å…¨ä¸Šä¸‹æ–‡åœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­å¾—åˆ°æ­£ç¡®ç®¡ç†å’Œä¼ é€’ï¼Œä»è€Œå®ç°åº”ç”¨ç¨‹åºçš„å®‰å…¨é˜²æŠ¤ã€‚</p><h3 id="_3-6logoutfilter" tabindex="-1">3.6LogoutFilter <a class="header-anchor" href="#_3-6logoutfilter" aria-label="Permalink to &quot;3.6LogoutFilter&quot;">â€‹</a></h3><p><code>LogoutFilter</code> æ˜¯ SpringSecurity æ¡†æ¶ä¸­çš„ä¸€ä¸ªå…³é”®è¿‡æ»¤å™¨ï¼Œç”¨äºå¤„ç†ç”¨æˆ·æ³¨é”€ï¼ˆlogoutï¼‰æ“ä½œã€‚ç”¨æˆ·æ³¨é”€æ˜¯æŒ‡ç”¨æˆ·ä¸»åŠ¨ç»ˆæ­¢å½“å‰ä¼šè¯å¹¶é€€å‡ºç™»å½•çŠ¶æ€çš„æ“ä½œï¼Œè€Œ <code>LogoutFilter</code> è´Ÿè´£åœ¨ç”¨æˆ·å‘èµ·æ³¨é”€è¯·æ±‚æ—¶æ‰§è¡Œç›¸åº”çš„å¤„ç†é€»è¾‘ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œ<code>LogoutFilter</code> ä¸»è¦å®Œæˆä»¥ä¸‹å‡ ä¸ªä»»åŠ¡ï¼š</p><ol><li>ç›‘å¬æ³¨é”€è¯·æ±‚ï¼šå½“ç”¨æˆ·å‘èµ·æ³¨é”€è¯·æ±‚æ—¶ï¼Œ<code>LogoutFilter</code> ä¼šæ‹¦æˆªè¯¥è¯·æ±‚ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæ³¨é”€è¯·æ±‚ä¼šä½¿ç”¨ HTTP çš„ GET æˆ– POST æ–¹æ³•ï¼Œå¹¶ä»¥ç‰¹å®šçš„ URL åœ°å€è¡¨ç¤ºã€‚</li><li>æ‰§è¡Œæ³¨é”€é€»è¾‘ï¼šä¸€æ—¦æ•è·åˆ°æ³¨é”€è¯·æ±‚ï¼Œ<code>LogoutFilter</code> å°†æ‰§è¡Œç›¸åº”çš„æ³¨é”€é€»è¾‘ï¼ŒåŒ…æ‹¬æ¸…é™¤ç”¨æˆ·çš„è®¤è¯ä¿¡æ¯ã€ä½¿å½“å‰ä¼šè¯å¤±æ•ˆã€æ¸…ç©ºå®‰å…¨ä¸Šä¸‹æ–‡ç­‰æ“ä½œã€‚</li><li>é‡å®šå‘æˆ–è¿”å›å“åº”ï¼šåœ¨æ‰§è¡Œå®Œæ³¨é”€é€»è¾‘åï¼Œ<code>LogoutFilter</code> å¯èƒ½ä¼šå°†ç”¨æˆ·é‡å®šå‘åˆ°æŒ‡å®šçš„é¡µé¢ï¼Œæˆ–è€…ç›´æ¥è¿”å›æ³¨é”€æˆåŠŸçš„å“åº”ã€‚</li></ol><p>åœ¨å…¸å‹çš„ Spring Security é…ç½®ä¸­ï¼Œ<code>LogoutFilter</code> é€šå¸¸ä½œä¸ºè¿‡æ»¤å™¨é“¾ä¸­çš„æœ€åä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œä»¥ç¡®ä¿åœ¨è¯·æ±‚å¤„ç†ç»“æŸåèƒ½å¤Ÿæ­£ç¡®å¤„ç†ç”¨æˆ·çš„æ³¨é”€è¯·æ±‚ã€‚</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			throws IOException, ServletException {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 1. æŸ¥çœ‹å½“å‰è¯·æ±‚è·¯å¾„æ˜¯å¦ç™»å‡ºï¼Œé»˜è®¤ç™»å‡ºè·¯å¾„ä¸º/logout</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">requiresLogout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 2. è·å–çº¿ç¨‹ä¸­çš„è®¤è¯ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			Authentication auth </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.securityContextHolderStrategy.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getAuthentication</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isDebugEnabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">				this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">debug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LogMessage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Logging out [%s]&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, auth));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 3. è°ƒç”¨ç™»å‡ºå¤„ç†å™¨å¤„ç†</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">			this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.handler.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">logout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response, auth);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 4. ç™»å‡ºæˆåŠŸå¤„ç†å™¨ï¼Œè·³è½¬åˆ°æŒ‡å®šé¡µé¢</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">			this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.logoutSuccessHandler.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onLogoutSuccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response, auth);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		chain.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span></code></pre></div><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ Spring Security ä¸­è¿›è¡ŒåŸºæœ¬çš„æ³¨é”€é…ç½®ï¼Œå¹¶æ¼”ç¤ºäº† <code>LogoutFilter</code> çš„ä½¿ç”¨ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SecurityFilterChain </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filterChain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpSecurity http) throws Exception {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> http</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // ...å…¶ä»–é…ç½®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">logout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">logoutUrl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/custom-logout&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è‡ªå®šä¹‰æ³¨é”€ URL</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">logoutSuccessUrl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/logout-success&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ³¨é”€æˆåŠŸåçš„è·³è½¬é¡µé¢</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addLogoutHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CustomLogoutHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ·»åŠ è‡ªå®šä¹‰çš„æ³¨é”€å¤„ç†å™¨</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">invalidateHttpSession</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä½¿å½“å‰ä¼šè¯å¤±æ•ˆ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">deleteCookies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;JSESSIONID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åˆ é™¤æŒ‡å®šçš„ Cookie</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">permitAll</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">and</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // ...å…¶ä»–é…ç½®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>åœ¨è¿™ä¸ªé…ç½®ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>.logout()</code> æ–¹æ³•é…ç½®äº†æ³¨é”€ç›¸å…³çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ³¨é”€ URLã€æ³¨é”€æˆåŠŸåçš„è·³è½¬é¡µé¢ã€è‡ªå®šä¹‰çš„æ³¨é”€å¤„ç†å™¨ã€æ˜¯å¦ä½¿å½“å‰ä¼šè¯å¤±æ•ˆä»¥åŠéœ€è¦åˆ é™¤çš„ Cookie ç­‰ã€‚</p><p><code>LogoutFilter</code> åœ¨ <strong>SpringSecurity</strong> ä¸­æ‰®æ¼”ç€å¤„ç†ç”¨æˆ·æ³¨é”€è¯·æ±‚çš„é‡è¦è§’è‰²ï¼Œå®ƒæ˜¯å®ç°ç”¨æˆ·æ³¨é”€åŠŸèƒ½çš„å…³é”®ç»„æˆéƒ¨åˆ†ã€‚é€šè¿‡åˆç†åœ°é…ç½®å’Œä½¿ç”¨ <code>LogoutFilter</code>ï¼Œå¯ä»¥ç¡®ä¿ç”¨æˆ·çš„æ³¨é”€æ“ä½œå¾—åˆ°æ­£ç¡®å¤„ç†ï¼Œä»è€Œæå‡åº”ç”¨ç¨‹åºçš„ç”¨æˆ·ä½“éªŒå’Œå®‰å…¨æ€§ã€‚</p><h3 id="_3-7usernamepasswordauthenticationfilter" tabindex="-1">3.7UsernamePasswordAuthenticationFilter <a class="header-anchor" href="#_3-7usernamepasswordauthenticationfilter" aria-label="Permalink to &quot;3.7UsernamePasswordAuthenticationFilter&quot;">â€‹</a></h3><p><code>UsernamePasswordAuthenticationFilter</code> æ˜¯ SpringSecurity æ¡†æ¶ä¸­çš„ä¸€ä¸ªæ ¸å¿ƒè¿‡æ»¤å™¨ï¼Œç”¨äºå¤„ç†åŸºäºç”¨æˆ·åå¯†ç çš„èº«ä»½è®¤è¯è¯·æ±‚ã€‚å®ƒæ˜¯å®ç°ç”¨æˆ·ç™»å½•éªŒè¯çš„å…³é”®ç»„ä»¶ä¹‹ä¸€ï¼Œè´Ÿè´£ä»ç”¨æˆ·æäº¤çš„ç”¨æˆ·åå¯†ç ä¿¡æ¯è¿›è¡Œè®¤è¯ï¼Œå¹¶åœ¨è®¤è¯æˆåŠŸåç”Ÿæˆç›¸åº”çš„è®¤è¯ä¿¡æ¯ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œ<code>UsernamePasswordAuthenticationFilter</code> ä¸»è¦å®Œæˆä»¥ä¸‹å‡ ä¸ªä»»åŠ¡ï¼š</p><ol><li>ç›‘å¬è®¤è¯è¯·æ±‚ï¼šå½“ç”¨æˆ·æäº¤ç”¨æˆ·åå¯†ç ç­‰è®¤è¯ä¿¡æ¯æ—¶ï¼Œ<code>UsernamePasswordAuthenticationFilter</code> ä¼šæ‹¦æˆªè¯¥è¯·æ±‚ï¼Œå¹¶è¿›è¡Œèº«ä»½è®¤è¯å¤„ç†ã€‚</li><li>æå–è®¤è¯ä¿¡æ¯ï¼šä»ç”¨æˆ·æäº¤çš„è¯·æ±‚ä¸­æå–ç”¨æˆ·åå¯†ç ç­‰èº«ä»½è®¤è¯ä¿¡æ¯ã€‚</li><li>æ‰§è¡Œè®¤è¯é€»è¾‘ï¼šä½¿ç”¨æå–åˆ°çš„ç”¨æˆ·åå¯†ç ä¿¡æ¯è¿›è¡Œå®é™…çš„èº«ä»½è®¤è¯è¿‡ç¨‹ï¼Œé€šå¸¸åŒ…æ‹¬éªŒè¯ç”¨æˆ·åå¯†ç çš„æ­£ç¡®æ€§ã€è·å–ç”¨æˆ·çš„æƒé™ä¿¡æ¯ç­‰æ“ä½œã€‚</li><li>è®¤è¯æˆåŠŸï¼šå¦‚æœè®¤è¯æˆåŠŸï¼Œ<code>UsernamePasswordAuthenticationFilter</code> å°†ç”Ÿæˆç›¸åº”çš„è®¤è¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç”¨æˆ·çš„ä¸»ä½“ï¼ˆPrincipalï¼‰ã€æƒé™ä¿¡æ¯ç­‰ï¼Œå¹¶å°†å…¶å­˜å‚¨åˆ°å®‰å…¨ä¸Šä¸‹æ–‡ä¸­ã€‚</li><li>è®¤è¯å¤±è´¥ï¼šå¦‚æœè®¤è¯å¤±è´¥ï¼Œ<code>UsernamePasswordAuthenticationFilter</code> å¯èƒ½ä¼šè¿”å›ç›¸åº”çš„è®¤è¯å¤±è´¥ä¿¡æ¯ï¼Œå¹¶é˜»æ­¢ç”¨æˆ·ç»§ç»­è®¿é—®å—ä¿æŠ¤çš„èµ„æºã€‚</li></ol><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Authentication </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">attemptAuthentication</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpServletRequest request, HttpServletResponse response)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			throws AuthenticationException {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 1. æ ¡éªŒè¯·æ±‚æ–¹å¼</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.postOnly </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">request.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMethod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">equals</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;POST&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AuthenticationServiceException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Authentication method not supported: &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> request.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMethod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 2. è·å–è¯·æ±‚å‚æ•°ä¸­çš„ç”¨æˆ·åã€å¯†ç </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		String username </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> obtainUsername</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		username </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (username </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> username.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">trim</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		String password </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> obtainPassword</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		password </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (password </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> password </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 3. åˆ›å»ºè®¤è¯ä»¤ç‰Œ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		UsernamePasswordAuthenticationToken authRequest </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UsernamePasswordAuthenticationToken.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unauthenticated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(username,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				password);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// Allow subclasses to set the &quot;details&quot; property</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">		setDetails</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, authRequest);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 4. è®¤è¯ç®¡ç†å™¨è¿›è¡Œè®¤è¯</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getAuthenticationManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authenticate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(authRequest);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span></code></pre></div><p>åœ¨<strong>SpringSecurity</strong> é…ç½®ä¸­ï¼Œ<code>UsernamePasswordAuthenticationFilter</code> è¢«é»˜è®¤é…ç½®ä¸ºè¿‡æ»¤å™¨é“¾ä¸­çš„ç¬¬ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œä»¥ç¡®ä¿åœ¨ç”¨æˆ·ç™»å½•è¯·æ±‚åˆ°è¾¾åç«¯åº”ç”¨ç¨‹åºæ—¶èƒ½å¤Ÿæ­£ç¡®å¤„ç†èº«ä»½è®¤è¯é€»è¾‘ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨<strong>SpringSecurity</strong> ä¸­è¿›è¡ŒåŸºæœ¬çš„èº«ä»½è®¤è¯é…ç½®ï¼Œå¹¶æ¼”ç¤ºäº† <code>UsernamePasswordAuthenticationFilter</code> çš„ä½¿ç”¨ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SecurityFilterChain </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filterChain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpSecurity http) throws Exception {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> http</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">             .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authorizeRequests</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">anyRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authenticated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">and</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">formLogin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">loginPage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/login&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è‡ªå®šä¹‰ç™»å½•é¡µé¢</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">permitAll</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">and</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addFilterBefore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UsernamePasswordAuthenticationFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), UsernamePasswordAuthenticationFilter.class);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>åœ¨è¿™ä¸ªé…ç½®ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>.formLogin()</code> æ–¹æ³•é…ç½®äº†ç™»å½•ç›¸å…³çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬è‡ªå®šä¹‰çš„ç™»å½•é¡µé¢å’Œå…è®¸æ‰€æœ‰ç”¨æˆ·è®¿é—®ç™»å½•é¡µé¢ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬é€šè¿‡ <code>addFilterBefore</code> æ–¹æ³•å°†è‡ªå®šä¹‰çš„ <code>UsernamePasswordAuthenticationFilter</code> æ·»åŠ åˆ°äº†è¿‡æ»¤å™¨é“¾ä¸­ï¼Œä»¥ç¡®ä¿åœ¨è¯·æ±‚è¿›å…¥åº”ç”¨ç¨‹åºæ—¶èƒ½å¤Ÿæ­£ç¡®å¤„ç†èº«ä»½è®¤è¯é€»è¾‘ã€‚</p><p><code>UsernamePasswordAuthenticationFilter</code> åœ¨ Spring Security ä¸­æ‰®æ¼”ç€å¤„ç†ç”¨æˆ·èº«ä»½è®¤è¯è¯·æ±‚çš„é‡è¦è§’è‰²ï¼Œå®ƒæ˜¯ç¡®ä¿ç”¨æˆ·èº«ä»½å¾—åˆ°æ­£ç¡®éªŒè¯å¹¶ç”Ÿæˆç›¸åº”è®¤è¯ä¿¡æ¯çš„å…³é”®ç»„ä»¶ã€‚é€šè¿‡åˆç†åœ°é…ç½®å’Œä½¿ç”¨ <code>UsernamePasswordAuthenticationFilter</code>ï¼Œå¯ä»¥å®ç°åº”ç”¨ç¨‹åºçš„å®‰å…¨è®¤è¯åŠŸèƒ½ï¼Œä¿æŠ¤ç³»ç»Ÿä¸å—æœªç»æˆæƒçš„è®¿é—®ã€‚</p><h3 id="_3-8defaultloginpagegeneratingfilter" tabindex="-1">3.8DefaultLoginPageGeneratingFilter <a class="header-anchor" href="#_3-8defaultloginpagegeneratingfilter" aria-label="Permalink to &quot;3.8DefaultLoginPageGeneratingFilter&quot;">â€‹</a></h3><p><code>DefaultLoginPageGeneratingFilter</code> æ˜¯ Spring Securityæ¡†æ¶ä¸­çš„ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œç”¨äºç”Ÿæˆé»˜è®¤çš„ç™»å½•é¡µé¢ã€‚å½“åº”ç”¨ç¨‹åºéœ€è¦ç”¨æˆ·ç™»å½•ä½†æœªé…ç½®è‡ªå®šä¹‰çš„ç™»å½•é¡µé¢æ—¶ï¼Œ<code>DefaultLoginPageGeneratingFilter</code> å°†è´Ÿè´£ç”Ÿæˆä¸€ä¸ªç®€å•çš„é»˜è®¤ç™»å½•é¡µé¢ï¼Œå¹¶åœ¨ç”¨æˆ·è®¿é—®æœªæˆæƒèµ„æºæ—¶å¼•å¯¼ç”¨æˆ·è¿›è¡Œç™»å½•ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œ<code>DefaultLoginPageGeneratingFilter</code> ä¸»è¦å®Œæˆä»¥ä¸‹å‡ ä¸ªä»»åŠ¡ï¼š</p><ol><li>ç›‘å¬æœªæˆæƒè¯·æ±‚ï¼šå½“ç”¨æˆ·å°è¯•è®¿é—®å—ä¿æŠ¤çš„èµ„æºä½†æœªè¿›è¡Œç™»å½•è®¤è¯æ—¶ï¼Œ<code>DefaultLoginPageGeneratingFilter</code> ä¼šæ‹¦æˆªè¯¥è¯·æ±‚ï¼Œå¹¶è¿›è¡Œå¤„ç†ã€‚</li><li>ç”Ÿæˆé»˜è®¤ç™»å½•é¡µé¢ï¼šå¦‚æœåº”ç”¨ç¨‹åºæœªé…ç½®è‡ªå®šä¹‰çš„ç™»å½•é¡µé¢ï¼Œ<code>DefaultLoginPageGeneratingFilter</code> å°†ç”Ÿæˆä¸€ä¸ªç®€å•çš„é»˜è®¤ç™»å½•é¡µé¢ï¼ŒåŒ…æ‹¬ç”¨æˆ·åå¯†ç è¾“å…¥æ¡†ã€ç™»å½•æŒ‰é’®ç­‰åŸºæœ¬å…ƒç´ ã€‚</li><li>å¼•å¯¼ç”¨æˆ·è¿›è¡Œç™»å½•ï¼šå°†ç”Ÿæˆçš„é»˜è®¤ç™»å½•é¡µé¢è¿”å›ç»™ç”¨æˆ·ï¼Œä»¥å¼•å¯¼ç”¨æˆ·è¿›è¡Œèº«ä»½è®¤è¯æ“ä½œã€‚</li></ol><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			throws IOException, ServletException {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> loginError </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isErrorPage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ˜¯å¦ç™»å½•é”™è¯¯ /login?error</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> logoutSuccess </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isLogoutSuccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ˜¯å¦ç™»å½•æˆåŠŸ /login?logout</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isLoginUrlRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> loginError </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> logoutSuccess) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			//1.  /login?errorã€/login?logoutã€/login ä¸‰ç§è¯·æ±‚URLä¸­çš„ä»»æ„ä¸€ç§ä¼šè¿›å…¥è¯¥æ–¹æ³•</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			//2. ç”Ÿæˆç™»å½•é¡µ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			String loginPageHtml </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> generateLoginPageHtml</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, loginError, logoutSuccess);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			response.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setContentType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;text/html;charset=UTF-8&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			response.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setContentLength</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(loginPageHtml.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getBytes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(StandardCharsets.UTF_8).length);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			//3. ç›´æ¥å†™å‡ºï¼Œå¹¶ç»“æŸ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			response.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getWriter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(loginPageHtml);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		chain.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span></code></pre></div><p>åœ¨å…¸å‹çš„ SpringSecurity é…ç½®ä¸­ï¼Œ<code>DefaultLoginPageGeneratingFilter</code> é€šå¸¸ä½œä¸ºè¿‡æ»¤å™¨é“¾ä¸­çš„å…¶ä¸­ä¸€ä¸ªè¿‡æ»¤å™¨å­˜åœ¨ï¼Œä»¥ä¾¿åœ¨ç”¨æˆ·è®¿é—®å—ä¿æŠ¤èµ„æºä½†æœªè¿›è¡Œç™»å½•è®¤è¯æ—¶ï¼Œèƒ½å¤Ÿæ­£ç¡®ç”Ÿæˆé»˜è®¤çš„ç™»å½•é¡µé¢å¹¶å¼•å¯¼ç”¨æˆ·è¿›è¡Œç™»å½•æ“ä½œã€‚</p><p><img src="https://gaoziman.oss-cn-hangzhou.aliyuncs.com/Leo100/202311072322540.png" alt="image-20231107232222152"></p><p>åœ¨<code>generateLoginPageHtml</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥äº†ä¸€ä¸ª<code>HTML</code>ç™»å½•é¡µé¢ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æœ€å¼€å§‹å¼•å…¥SpringSecurityä¾èµ–ä¹‹åçš„é‚£ä¸ªé»˜è®¤ç™»å½•é¡µé¢ã€‚</p><p>ä¸‹é¢é€šè¿‡ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨SpringSecurity ä¸­è¿›è¡ŒåŸºæœ¬çš„èº«ä»½è®¤è¯é…ç½®ï¼Œå¹¶æ¼”ç¤ºäº† <code>DefaultLoginPageGeneratingFilter</code> çš„ä½¿ç”¨ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SecurityFilterChain </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filterChain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpSecurity http) throws Exception {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> http</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">              .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authorizeRequests</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">anyRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authenticated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">and</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">formLogin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">and</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addFilterBefore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DefaultLoginPageGeneratingFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), UsernamePasswordAuthenticationFilter.class);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>åœ¨è¿™ä¸ªé…ç½®ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>.formLogin()</code> æ–¹æ³•é…ç½®äº†ç™»å½•ç›¸å…³çš„ä¿¡æ¯ï¼Œä½†æœªæŒ‡å®šè‡ªå®šä¹‰çš„ç™»å½•é¡µé¢ï¼Œå› æ­¤ <code>DefaultLoginPageGeneratingFilter</code> å°†ä¼šè¢«è§¦å‘ä»¥ç”Ÿæˆé»˜è®¤çš„ç™»å½•é¡µé¢ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬é€šè¿‡ <code>addFilterBefore</code> æ–¹æ³•å°† <code>DefaultLoginPageGeneratingFilter</code> æ·»åŠ åˆ°äº†è¿‡æ»¤å™¨é“¾ä¸­ã€‚</p><p><code>DefaultLoginPageGeneratingFilter</code> åœ¨ Spring Security ä¸­èµ·ç€ç”Ÿæˆé»˜è®¤ç™»å½•é¡µé¢ï¼Œå¼•å¯¼ç”¨æˆ·è¿›è¡Œç™»å½•çš„é‡è¦ä½œç”¨ã€‚å½“åº”ç”¨ç¨‹åºéœ€è¦ä¸€ä¸ªç®€å•çš„ç™»å½•é¡µé¢æ¥å¼•å¯¼ç”¨æˆ·è¿›è¡Œèº«ä»½è®¤è¯æ—¶ï¼Œå¯ä»¥å€ŸåŠ© <code>DefaultLoginPageGeneratingFilter</code> æ¥å¿«é€Ÿå®ç°è¿™ä¸€åŠŸèƒ½ï¼Œä»è€Œæå‡ç³»ç»Ÿçš„ç”¨æˆ·å‹å¥½æ€§å’Œå®‰å…¨æ€§ã€‚</p><h3 id="_3-9defaultlogoutpagegeneratingfilter" tabindex="-1">3.9DefaultLogoutPageGeneratingFilter <a class="header-anchor" href="#_3-9defaultlogoutpagegeneratingfilter" aria-label="Permalink to &quot;3.9DefaultLogoutPageGeneratingFilter&quot;">â€‹</a></h3><p><code>DefaultLogoutPageGeneratingFilter</code>å’Œä¸Šé¢ä¸€æ ·ï¼Œå¦‚æœè¯·æ±‚<code>URL</code>æ˜¯<code>/logout</code>ï¼Œç›´æ¥ç”Ÿæˆä¸€ä¸ªç¡®è®¤é€€å‡ºé¡µé¢ã€‚</p><p><img src="https://gaoziman.oss-cn-hangzhou.aliyuncs.com/Leo100/202311072326953.png" alt="image-20231107232600856"></p><h3 id="_3-10basicauthenticationfilter" tabindex="-1">3.10BasicAuthenticationFilter <a class="header-anchor" href="#_3-10basicauthenticationfilter" aria-label="Permalink to &quot;3.10BasicAuthenticationFilter&quot;">â€‹</a></h3><p><code>BasicAuthenticationFilter</code>å¤„ç†<code>BASIC</code>è®¤è¯ï¼ˆè¯·æ±‚å¤´ä¸­æºå¸¦<code>BASIC</code> +ç‰¹æ®Šæ ¼å¼ç”¨æˆ·åå¯†ç ï¼‰ï¼Œé™¤è¡¨å•ç™»å½•çš„å¦ä¸€ç§ç™»å½•æ–¹å¼ï¼Œä½†æ˜¯ç›®å‰ç”¨çš„å¾ˆå°‘ï¼Œå’Œè¡¨å•ç™»å½•é€»è¾‘ç±»ä¼¼ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> doFilterInternal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			throws IOException, ServletException {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			UsernamePasswordAuthenticationToken authRequest </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.authenticationConverter.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">convert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (authRequest </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">				this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">trace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Did not process authentication request since failed to find &quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">						+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;username and password in Basic Authorization header&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				chain.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			String username </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> authRequest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">			this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">trace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LogMessage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Found username &#39;%s&#39; in Basic Authorization header&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, username));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authenticationIsRequired</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(username)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				Authentication authResult </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.authenticationManager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authenticate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(authRequest);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				SecurityContext context </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.securityContextHolderStrategy.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createEmptyContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setAuthentication</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(authResult);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">				this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.securityContextHolderStrategy.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(context);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isDebugEnabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">					this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">debug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LogMessage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Set SecurityContextHolder to %s&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, authResult));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				}</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">				this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.rememberMeServices.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">loginSuccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response, authResult);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">				this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.securityContextRepository.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">saveContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(context, request, response);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">				onSuccessfulAuthentication</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response, authResult);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (AuthenticationException </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">			this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.securityContextHolderStrategy.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clearContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">			this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">debug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Failed to process authentication request&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ex);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">			this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.rememberMeServices.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">loginFail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">			onUnsuccessfulAuthentication</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response, ex);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.ignoreFailure) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				chain.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">				this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.authenticationEntryPoint.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">commence</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response, ex);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		chain.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span></code></pre></div><p>å…·ä½“æ¥è¯´ï¼Œ<code>BasicAuthenticationFilter</code> ä¸»è¦å®Œæˆä»¥ä¸‹å‡ ä¸ªä»»åŠ¡ï¼š</p><ol><li>æå–è®¤è¯ä¿¡æ¯ï¼šåœ¨æ¯ä¸ªè¯·æ±‚å¤„ç†ä¹‹å‰ï¼Œ<code>BasicAuthenticationFilter</code> ä¼šä»è¯·æ±‚å¤´ä¸­æå– Base64 ç¼–ç çš„ç”¨æˆ·åå’Œå¯†ç ä¿¡æ¯ï¼Œç”¨äºåç»­çš„èº«ä»½éªŒè¯ã€‚</li><li>æ‰§è¡Œèº«ä»½éªŒè¯ï¼š<code>BasicAuthenticationFilter</code> ä¼šå°†æå–åˆ°çš„ç”¨æˆ·åå’Œå¯†ç ä¿¡æ¯ä¼ é€’ç»™è®¤è¯ç®¡ç†å™¨ï¼ˆAuthenticationManagerï¼‰ï¼Œç”±è®¤è¯ç®¡ç†å™¨æ¥è¿›è¡Œå®é™…çš„èº«ä»½éªŒè¯æ“ä½œã€‚</li><li>å¤„ç†èº«ä»½éªŒè¯ç»“æœï¼šæ ¹æ®èº«ä»½éªŒè¯çš„ç»“æœï¼Œ<code>BasicAuthenticationFilter</code> ä¼šåœ¨å®‰å…¨ä¸Šä¸‹æ–‡ä¸­è®¾ç½®ç›¸åº”çš„è®¤è¯ä¿¡æ¯ï¼Œå¹¶æ ¹æ®è®¤è¯ç»“æœå†³å®šæ˜¯å¦å…è®¸è¯·æ±‚ç»§ç»­å¤„ç†ã€‚</li><li>é”™è¯¯å¤„ç†ï¼šå½“èº«ä»½éªŒè¯å¤±è´¥æ—¶ï¼Œ<code>BasicAuthenticationFilter</code> è´Ÿè´£è¿”å›é€‚å½“çš„èº«ä»½éªŒè¯å¤±è´¥å“åº”ï¼Œè¦æ±‚å®¢æˆ·ç«¯é‡æ–°å‘èµ·èº«ä»½éªŒè¯ã€‚</li></ol><p>é€šè¿‡åˆç†é…ç½® <code>BasicAuthenticationFilter</code>ï¼Œå¯ä»¥å®ç°å¯¹åŸºæœ¬è®¤è¯çš„è¯·æ±‚è¿›è¡Œèº«ä»½éªŒè¯ï¼Œå¹¶æ ¹æ®éªŒè¯ç»“æœå†³å®šæ˜¯å¦å…è®¸è¯·æ±‚ç»§ç»­å¤„ç†ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ <strong>SpringSecurity</strong> ä¸­é…ç½® <code>BasicAuthenticationFilter</code>ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SecurityFilterChain </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filterChain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpSecurity http) throws Exception {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> http</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             // ... å…¶ä»–é…ç½®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addFilterBefore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RequestCacheAwareFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), UsernamePasswordAuthenticationFilter.class);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>åœ¨è¿™ä¸ªé…ç½®ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>.addFilterBefore(new BasicAuthenticationFilter(authenticationManager()), UsernamePasswordAuthenticationFilter.class)</code> å°† <code>BasicAuthenticationFilter</code> æ·»åŠ åˆ°äº†è¿‡æ»¤å™¨é“¾ä¸­ï¼Œå¹¶ä¼ å…¥äº†è®¤è¯ç®¡ç†å™¨ä»¥è¿›è¡Œå®é™…çš„èº«ä»½éªŒè¯æ“ä½œã€‚</p><p><code>BasicAuthenticationFilter</code> åœ¨ Spring Security ä¸­æ‰®æ¼”ç€å¤„ç†åŸºæœ¬è®¤è¯ç›¸å…³é€»è¾‘çš„é‡è¦è§’è‰²ï¼Œé€šè¿‡å®ƒçš„é…ç½®å¯ä»¥å®ç°å¯¹åŸºæœ¬è®¤è¯çš„è¯·æ±‚è¿›è¡Œèº«ä»½éªŒè¯ï¼Œæé«˜ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œè®¿é—®æ§åˆ¶èƒ½åŠ›ã€‚</p><h3 id="_3-11requestcacheawarefilter" tabindex="-1">3.11RequestCacheAwareFilter <a class="header-anchor" href="#_3-11requestcacheawarefilter" aria-label="Permalink to &quot;3.11RequestCacheAwareFilter&quot;">â€‹</a></h3><p><code>RequestCacheAwareFilter</code>ç¼“å­˜è¢«ç™»å½•æ‰“æ–­çš„è¯·æ±‚ï¼Œä¾‹å¦‚è®¿é—®æŸä¸ª<code>URL</code>ï¼Œä¼šè°ƒè½¬åˆ°ç™»å½•é¡µé¢ï¼Œç™»å½•æˆåŠŸåï¼Œä¼šä»å½“å‰ç¼“å­˜ä¸­è·å–ä¹‹å‰è®¿é—®çš„<code>URL</code>ï¼Œç›´æ¥è·³è½¬åˆ°åŸæ¥çš„è¯·æ±‚ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			throws IOException, ServletException {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 1. è·å–ç¼“å­˜è¯·æ±‚</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		HttpServletRequest wrappedSavedRequest </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.requestCache.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMatchingRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((HttpServletRequest) request,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				(HttpServletResponse) response);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 2. å­˜åœ¨åˆ™ä¼ é€’ä¹‹å‰ç¼“å­˜çš„è¯·æ±‚å¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		chain.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((wrappedSavedRequest </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> wrappedSavedRequest </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> request, response);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span></code></pre></div><p>å…·ä½“æ¥è¯´ï¼Œ<code>RequestCacheAwareFilter</code> ä¸»è¦å®Œæˆä»¥ä¸‹å‡ ä¸ªä»»åŠ¡ï¼š</p><ol><li>è¯·æ±‚ç¼“å­˜ï¼šåœ¨ç”¨æˆ·å®Œæˆèº«ä»½éªŒè¯å‰ï¼Œ<code>RequestCacheAwareFilter</code> ä¼šå°†åŸå§‹çš„è¯·æ±‚ä¿¡æ¯ä¿å­˜åˆ°è¯·æ±‚ç¼“å­˜ä¸­ï¼Œè¿™æ ·ç”¨æˆ·å®Œæˆèº«ä»½éªŒè¯åå°±å¯ä»¥è·å–åˆ°è¿™äº›åŸå§‹è¯·æ±‚ä¿¡æ¯ã€‚</li><li>è¯·æ±‚ä¿¡æ¯çš„æ¢å¤ï¼šå½“ç”¨æˆ·å®Œæˆèº«ä»½éªŒè¯åï¼Œ<code>RequestCacheAwareFilter</code> ä¼šæ ¹æ®è¯·æ±‚ç¼“å­˜ä¸­çš„ä¿¡æ¯ï¼Œå°†ç”¨æˆ·åŸå§‹çš„è¯·æ±‚ä¿¡æ¯ï¼ˆå¦‚è¯·æ±‚ URLã€è¯·æ±‚å‚æ•°ç­‰ï¼‰æ¢å¤ï¼Œä»è€Œè®©ç”¨æˆ·èƒ½å¤Ÿç»§ç»­ä¹‹å‰è¢«ä¸­æ–­çš„è¯·æ±‚å¤„ç†æµç¨‹ã€‚</li><li>ä¸å…¶ä»–å®‰å…¨ç»„ä»¶çš„åä½œï¼š<code>RequestCacheAwareFilter</code> é€šå¸¸ä¸å…¶ä»–å®‰å…¨ç»„ä»¶ï¼ˆå¦‚èº«ä»½éªŒè¯è¿‡æ»¤å™¨ã€è®¿é—®æ§åˆ¶è¿‡æ»¤å™¨ç­‰ï¼‰ååŒå·¥ä½œï¼Œç¡®ä¿åœ¨ç”¨æˆ·å®Œæˆèº«ä»½éªŒè¯åèƒ½å¤Ÿæ­£ç¡®åœ°æ¢å¤åŸå§‹çš„è¯·æ±‚ä¿¡æ¯ã€‚</li></ol><p>é€šè¿‡åˆç†é…ç½® <code>RequestCacheAwareFilter</code>ï¼Œå¯ä»¥å®ç°ç”¨æˆ·å®Œæˆèº«ä»½éªŒè¯åèƒ½å¤Ÿæ— ç¼åœ°ç»§ç»­ä¹‹å‰çš„è¯·æ±‚å¤„ç†æµç¨‹ï¼Œæé«˜ç³»ç»Ÿçš„ç”¨æˆ·ä½“éªŒå’ŒåŠŸèƒ½å®Œæ•´æ€§ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ <strong>SpringSecurity</strong> ä¸­é…ç½® <code>RequestCacheAwareFilter</code>ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SecurityFilterChain </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filterChain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpSecurity http) throws Exception {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> http</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             // ... å…¶ä»–é…ç½®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addFilterBefore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RequestCacheAwareFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), UsernamePasswordAuthenticationFilter.class);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>åœ¨è¿™ä¸ªé…ç½®ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>.addFilterBefore(new RequestCacheAwareFilter(), UsernamePasswordAuthenticationFilter.class)</code> å°† <code>RequestCacheAwareFilter</code> æ·»åŠ åˆ°äº†è¿‡æ»¤å™¨é“¾ä¸­ã€‚</p><p><code>RequestCacheAwareFilter</code> åœ¨ Spring Security ä¸­æ‰®æ¼”ç€ä¿å­˜å’Œæ¢å¤ç”¨æˆ·åŸå§‹è¯·æ±‚ä¿¡æ¯çš„é‡è¦è§’è‰²ï¼Œé€šè¿‡å®ƒçš„é…ç½®å¯ä»¥å®ç°ç”¨æˆ·å®Œæˆèº«ä»½éªŒè¯åèƒ½å¤Ÿæ— ç¼åœ°ç»§ç»­ä¹‹å‰çš„è¯·æ±‚å¤„ç†æµç¨‹ï¼Œæé«˜ç³»ç»Ÿçš„ç”¨æˆ·ä½“éªŒå’ŒåŠŸèƒ½å®Œæ•´æ€§ã€‚</p><h3 id="_3-12securitycontextholderawarerequestfilter" tabindex="-1">3.12SecurityContextHolderAwareRequestFilter <a class="header-anchor" href="#_3-12securitycontextholderawarerequestfilter" aria-label="Permalink to &quot;3.12SecurityContextHolderAwareRequestFilter&quot;">â€‹</a></h3><p><code>SecurityContextHolderAwareRequestFilter</code> å°†è¯·æ±‚åŒ…è£…ä¸º<code>Servlet3SecurityContextHolderAwareRequestWrapper</code>ï¼š</p><p>å…·ä½“æ¥è¯´ï¼Œ<code>SecurityContextHolderAwareRequestFilter</code> ä¸»è¦å®Œæˆä»¥ä¸‹å‡ ä¸ªä»»åŠ¡ï¼š</p><ol><li>å°†å®‰å…¨ä¸Šä¸‹æ–‡ä¿¡æ¯ä¸è¯·æ±‚å…³è”ï¼šåœ¨æ¯ä¸ªè¯·æ±‚å¤„ç†ä¹‹å‰ï¼Œ<code>SecurityContextHolderAwareRequestFilter</code> ä¼šå°†å½“å‰çš„å®‰å…¨ä¸Šä¸‹æ–‡ä¿¡æ¯ç»‘å®šåˆ°å½“å‰çš„ HTTP è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­ï¼Œè¿™æ ·åœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­å¯ä»¥æ–¹ä¾¿åœ°è·å–å’Œæ“ä½œå®‰å…¨ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</li><li>æä¾›æ–¹ä¾¿çš„å®‰å…¨ä¸Šä¸‹æ–‡è®¿é—®æ–¹å¼ï¼šé€šè¿‡ <code>SecurityContextHolderAwareRequestFilter</code>ï¼Œå¯ä»¥åœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­ä»¥ä¸€ç§æ–¹ä¾¿çš„æ–¹å¼è·å–å½“å‰çš„è®¤è¯ä¿¡æ¯ã€æƒé™ä¿¡æ¯ç­‰å®‰å…¨ä¸Šä¸‹æ–‡ç›¸å…³çš„ä¿¡æ¯ï¼Œè€Œä¸éœ€è¦æ˜¾å¼åœ°ä» <code>SecurityContextHolder</code> ä¸­è·å–ã€‚</li><li>ä¸å…¶ä»–å®‰å…¨ç»„ä»¶çš„åä½œï¼š<code>SecurityContextHolderAwareRequestFilter</code> é€šå¸¸ä¸å…¶ä»–å®‰å…¨ç»„ä»¶ï¼ˆå¦‚èº«ä»½éªŒè¯è¿‡æ»¤å™¨ã€è®¿é—®æ§åˆ¶è¿‡æ»¤å™¨ç­‰ï¼‰ååŒå·¥ä½œï¼Œç¡®ä¿å®‰å…¨ä¸Šä¸‹æ–‡ä¿¡æ¯èƒ½å¤Ÿåœ¨æ•´ä¸ªè¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­å¾—åˆ°æ­£ç¡®çš„ä¼ é€’å’Œä½¿ç”¨ã€‚</li></ol><p>é€šè¿‡åˆç†é…ç½® <code>SecurityContextHolderAwareRequestFilter</code>ï¼Œå¯ä»¥å®ç°å®‰å…¨ä¸Šä¸‹æ–‡ä¿¡æ¯ä¸ HTTP è¯·æ±‚çš„æœ‰æ•ˆå…³è”ï¼Œæé«˜ç³»ç»Ÿå¯¹å®‰å…¨ä¿¡æ¯çš„å¤„ç†æ•ˆç‡å’Œä¾¿åˆ©æ€§ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ <strong>SpringSecurity</strong> ä¸­é…ç½® <code>SecurityContextHolderAwareRequestFilter</code>ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SecurityFilterChain </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filterChain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpSecurity http) throws Exception {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> http</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">               // ... å…¶ä»–é…ç½®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addFilterBefore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SecurityContextHolderAwareRequestFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), UsernamePasswordAuthenticationFilter.class);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>åœ¨è¿™ä¸ªé…ç½®ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>.addFilterBefore(new SecurityContextHolderAwareRequestFilter(), UsernamePasswordAuthenticationFilter.class)</code> å°† <code>SecurityContextHolderAwareRequestFilter</code> æ·»åŠ åˆ°äº†è¿‡æ»¤å™¨é“¾ä¸­ã€‚</p><p>æ€»ä¹‹ï¼Œ<code>SecurityContextHolderAwareRequestFilter</code> åœ¨ Spring Security ä¸­æ‰®æ¼”ç€å°†å®‰å…¨ä¸Šä¸‹æ–‡ä¿¡æ¯ä¸ HTTP è¯·æ±‚å…³è”çš„é‡è¦è§’è‰²ï¼Œé€šè¿‡å®ƒçš„é…ç½®å¯ä»¥å®ç°åœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­æ–¹ä¾¿åœ°è·å–å’Œæ“ä½œå®‰å…¨ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæé«˜ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œå¼€å‘æ•ˆç‡ã€‚</p><h3 id="_3-13anonymousauthenticationfilter" tabindex="-1">3.13AnonymousAuthenticationFilter <a class="header-anchor" href="#_3-13anonymousauthenticationfilter" aria-label="Permalink to &quot;3.13AnonymousAuthenticationFilter&quot;">â€‹</a></h3><p><code>Anonymous</code>æ˜¯åŒ¿åç”¨æˆ·çš„æ„æ€ï¼Œå½“ä¹‹å‰çš„è¿‡æ»¤å™¨æ²¡æœ‰å‘ç°è®¤è¯çš„ç”¨æˆ·ä¿¡æ¯æ—¶ï¼Œä¼šåœ¨<code>AnonymousAuthenticationFilter</code>è¿‡æ»¤å™¨ä¸­åˆ›å»ºä¸€ä¸ªåŒ¿åç”¨æˆ·ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			throws IOException, ServletException {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		Supplier&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SecurityContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; deferredContext </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.securityContextHolderStrategy.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getDeferredContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">		this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.securityContextHolderStrateg.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setDeferredContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">defaultWithAnonymous</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((HttpServletRequest) req, deferredContext));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		chain.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(req, res);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span></code></pre></div><p>è¿™ä¸ªåŒ¿åèº«ä»½ä¿¡æ¯å…è®¸åŒ¿åç”¨æˆ·åœ¨ç³»ç»Ÿä¸­è¿›è¡Œä¸€å®šç¨‹åº¦çš„æ“ä½œï¼Œæ¯”å¦‚è®¿é—®å…¬å¼€çš„èµ„æºæˆ–è¿›è¡Œæœ‰é™åˆ¶çš„æ“ä½œã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œ<code>AnonymousAuthenticationFilter</code> ä¸»è¦å®Œæˆä»¥ä¸‹å‡ ä¸ªä»»åŠ¡ï¼š</p><ol><li>åŒ¿åèº«ä»½çš„åˆ›å»ºï¼šå½“ç”¨æˆ·å°šæœªè¿›è¡Œè®¤è¯æ—¶ï¼Œ<code>AnonymousAuthenticationFilter</code> è´Ÿè´£åˆ›å»ºä¸€ä¸ªåŒ¿åçš„èº«ä»½ä¿¡æ¯ï¼Œå¹¶å°†å…¶ç»‘å®šåˆ°å½“å‰çš„å®‰å…¨ä¸Šä¸‹æ–‡ä¸­ã€‚</li><li>å®‰å…¨ä¸Šä¸‹æ–‡çš„ç»´æŠ¤ï¼š<code>AnonymousAuthenticationFilter</code> å°†è´Ÿè´£ç»´æŠ¤å½“å‰è¯·æ±‚çš„å®‰å…¨ä¸Šä¸‹æ–‡ï¼Œç¡®ä¿åŒ¿åç”¨æˆ·åœ¨ç³»ç»Ÿä¸­èƒ½å¤Ÿå¾—åˆ°é€‚å½“çš„å¤„ç†å’Œæƒé™æ§åˆ¶ã€‚</li><li>ä¸å…¶ä»–èº«ä»½éªŒè¯è¿‡æ»¤å™¨çš„åä½œï¼š<code>AnonymousAuthenticationFilter</code> é€šå¸¸ä¸å…¶ä»–èº«ä»½éªŒè¯è¿‡æ»¤å™¨ï¼ˆæ¯”å¦‚è¡¨å•ç™»å½•è¿‡æ»¤å™¨ã€åŸºæœ¬è®¤è¯è¿‡æ»¤å™¨ç­‰ï¼‰ååŒå·¥ä½œï¼Œç¡®ä¿åœ¨ç”¨æˆ·æœªè¿›è¡Œè®¤è¯æ—¶èƒ½å¤Ÿåˆ›å»ºå¹¶ä½¿ç”¨åŒ¿åèº«ä»½ä¿¡æ¯ã€‚</li></ol><p>é€šè¿‡åˆç†é…ç½® <code>AnonymousAuthenticationFilter</code>ï¼Œå¯ä»¥å®ç°å¯¹åŒ¿åç”¨æˆ·çš„å®‰å…¨ç®¡ç†ï¼Œç¡®ä¿ä»–ä»¬åœ¨ç³»ç»Ÿä¸­çš„åˆæ³•æ“ä½œä¸å½±å“ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ Spring Security ä¸­é…ç½® <code>AnonymousAuthenticationFilter</code>ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SecurityFilterChain </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filterChain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpSecurity http) throws Exception {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> http</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">             .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authorizeRequests</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">antMatchers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/public/**&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">permitAll</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">anyRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authenticated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">and</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">formLogin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">and</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addFilterBefore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AnonymousAuthenticationFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;anonymousUser&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), UsernamePasswordAuthenticationFilter.class);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>åœ¨è¿™ä¸ªé…ç½®ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>.antMatchers(&quot;/public/**&quot;).permitAll()</code> é…ç½®äº†å¯¹ <code>/public/**</code> è·¯å¾„ä¸‹çš„èµ„æºçš„å…¬å¼€è®¿é—®æƒé™ï¼Œå¹¶é€šè¿‡ <code>AnonymousAuthenticationFilter</code> åˆ›å»ºäº†ä¸€ä¸ªåä¸º <code>anonymousUser</code> çš„åŒ¿åèº«ä»½ä¿¡æ¯ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°äº†è¿‡æ»¤å™¨é“¾ä¸­ã€‚</p><p><code>AnonymousAuthenticationFilter</code> åœ¨ Spring Security ä¸­æ‰®æ¼”ç€ä¸ºåŒ¿åç”¨æˆ·åˆ›å»ºèº«ä»½ä¿¡æ¯çš„é‡è¦è§’è‰²ï¼Œé€šè¿‡å®ƒçš„é…ç½®å¯ä»¥æœ‰æ•ˆç®¡ç†åŒ¿åç”¨æˆ·åœ¨ç³»ç»Ÿä¸­çš„æ“ä½œå’Œæƒé™ï¼Œä»è€Œæé«˜ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒã€‚</p><h3 id="_3-14exceptiontranslationfilter" tabindex="-1">3.14ExceptionTranslationFilter <a class="header-anchor" href="#_3-14exceptiontranslationfilter" aria-label="Permalink to &quot;3.14ExceptionTranslationFilter&quot;">â€‹</a></h3><p><code>ExceptionTranslationFilter</code>æ˜¯æ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œå¯¹å¼‚å¸¸è¿›è¡Œè½¬æ¢å¤„ç†ï¼Œå¤„ç†è¿‡æ»¤å™¨ä¸­çš„æŠ›å‡º<code>AccessDeniedException</code>ã€<code>AuthenticationException</code>ï¼Œæä¾›äº†<code>Java</code>å¼‚å¸¸å’Œ<code>HTTP</code>å“åº”ä¹‹é—´çš„æ¡¥æ¢ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œ<code>ExceptionTranslationFilter</code> ä¸»è¦å®Œæˆä»¥ä¸‹å‡ ä¸ªä»»åŠ¡ï¼š</p><ol><li>å¼‚å¸¸è½¬æ¢ï¼šå½“å‘ç”Ÿå®‰å…¨ç›¸å…³çš„å¼‚å¸¸ï¼Œæ¯”å¦‚ç”¨æˆ·æœªè®¤è¯ã€æ— æƒé™è®¿é—®ç­‰æƒ…å†µæ—¶ï¼Œ<code>ExceptionTranslationFilter</code> å°†è´Ÿè´£å°†è¿™äº›å¼‚å¸¸è½¬æ¢ä¸ºç‰¹å®šçš„å“åº”ï¼Œæ¯”å¦‚è·³è½¬åˆ°ç™»å½•é¡µé¢ã€è¿”å›æ‹’ç»è®¿é—®çš„é”™è¯¯ä¿¡æ¯ç­‰ã€‚</li><li>å¼‚å¸¸å¤„ç†ï¼šé’ˆå¯¹ä¸åŒçš„å®‰å…¨å¼‚å¸¸ï¼Œ<code>ExceptionTranslationFilter</code> å¯ä»¥é…ç½®ç›¸åº”çš„å¼‚å¸¸å¤„ç†ç­–ç•¥ï¼Œæ¯”å¦‚è·³è½¬åˆ°ç‰¹å®šé¡µé¢ã€è¿”å›ç‰¹å®šçš„é”™è¯¯ç ç­‰ã€‚</li><li>ä¸å…¶ä»–è¿‡æ»¤å™¨çš„åä½œï¼š<code>ExceptionTranslationFilter</code> é€šå¸¸ä¸å…¶ä»–å®‰å…¨è¿‡æ»¤å™¨ï¼ˆæ¯”å¦‚èº«ä»½éªŒè¯è¿‡æ»¤å™¨ã€è®¿é—®æ§åˆ¶è¿‡æ»¤å™¨ç­‰ï¼‰ååŒå·¥ä½œï¼Œç¡®ä¿åœ¨å®‰å…¨ç›¸å…³çš„å¼‚å¸¸å‘ç”Ÿæ—¶èƒ½å¤Ÿå¾—åˆ°æ­£ç¡®å¤„ç†ã€‚</li></ol><p>é€šè¿‡åˆç†é…ç½® <code>ExceptionTranslationFilter</code>ï¼Œå¯ä»¥å®ç°å¯¹å®‰å…¨å¼‚å¸¸çš„ç»Ÿä¸€å¤„ç†ï¼Œæé«˜ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒã€‚</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			throws IOException, ServletException {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			chain.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (IOException </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ex;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Exception </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 1. å°è¯•ä»å †æ ˆä¸­æå– SpringSecurityå¼‚å¸¸</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// Try to extract a SpringSecurityException from the stacktrace</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			Throwable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] causeChain </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.throwableAnalyzer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">determineCauseChain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ex);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 2. åˆ†æå¼‚å¸¸æ˜¯å¦ AuthenticationException</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			RuntimeException securityException </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (AuthenticationException) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.throwableAnalyzer</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getFirstThrowableOfType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(AuthenticationException.class, causeChain);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 3. æ²¡æœ‰AuthenticationException,åˆ™è·å–AccessDeniedException</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (securityException </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				securityException </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (AccessDeniedException) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.throwableAnalyzer</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">						.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getFirstThrowableOfType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(AccessDeniedException.class, causeChain);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 4. ä¸æ˜¯AuthenticationExceptionã€AccessDeniedExceptionç›´æ¥æŠ›å‡º</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (securityException </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">				rethrow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ex);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (response.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isCommitted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ServletException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Unable to handle the Spring Security Exception &quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">						+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;because the response is already committed.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ex);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 5. å¤„ç†å¼‚å¸¸</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">			handleSpringSecurityException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response, chain, securityException);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span></code></pre></div><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ <strong>SpringSecurity</strong> ä¸­é…ç½® <code>ExceptionTranslationFilter</code>ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SecurityFilterChain </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filterChain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpSecurity http) throws Exception {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> http</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">             .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authorizeRequests</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">anyRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authenticated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">and</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">formLogin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">and</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">exceptionHandling</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">accessDeniedPage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/403&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é…ç½®è®¿é—®æ‹’ç»æ—¶çš„é¡µé¢</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">and</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addFilterBefore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ExceptionTranslationFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), FilterSecurityInterceptor.class);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>åœ¨è¿™ä¸ªé…ç½®ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>.exceptionHandling()</code> æ–¹æ³•é…ç½®äº†è®¿é—®æ‹’ç»æ—¶çš„å¤„ç†ç­–ç•¥ï¼Œå¹¶å°† <code>ExceptionTranslationFilter</code> æ·»åŠ åˆ°äº†è¿‡æ»¤å™¨é“¾ä¸­ã€‚</p><p><code>ExceptionTranslationFilter</code> åœ¨ Spring Security ä¸­æ‰®æ¼”ç€ç»Ÿä¸€å¤„ç†å®‰å…¨å¼‚å¸¸çš„é‡è¦è§’è‰²ï¼Œé€šè¿‡å®ƒçš„é…ç½®å¯ä»¥å®ç°å¯¹å„ç§å®‰å…¨å¼‚å¸¸çš„ç»Ÿä¸€å¤„ç†å’Œå“åº”å®šåˆ¶ï¼Œä»è€Œæå‡ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒã€‚</p><h3 id="_3-15authorizationfilter" tabindex="-1">3.15AuthorizationFilter <a class="header-anchor" href="#_3-15authorizationfilter" aria-label="Permalink to &quot;3.15AuthorizationFilter&quot;">â€‹</a></h3><p><strong>AuthorizationFilter</strong>æ˜¯æˆ‘ä»¬ä»‹ç»çš„æœ€åä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œ<code>Authorization</code>æ˜¯æˆæƒçš„æ„æ€ï¼Œå°±æ˜¯ç”¨æ¥æ£€éªŒæˆ‘ä»¬å½“å‰çš„è¯·æ±‚æ˜¯å¦å…·æœ‰ç›¸åº”çš„æƒé™ã€‚</p><p><code>AuthorizationFilter</code> å¹¶ä¸æ˜¯ä¸€ä¸ªå†…ç½®çš„ç±»æˆ–è¿‡æ»¤å™¨ã€‚ä¹Ÿè®¸æ‚¨åœ¨é—®çš„æ˜¯ <code>AuthorizationFilter</code> çš„æ¦‚å¿µæˆ–è€…ç±»ä¼¼çš„åŠŸèƒ½ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨ Spring Security ä¸­å®ç°æƒé™æ§åˆ¶çš„è¿‡æ»¤å™¨æ˜¯ <code>FilterSecurityInterceptor</code>ã€‚</p><p><code>FilterSecurityInterceptor</code> æ˜¯ Spring Security ä¸­è´Ÿè´£è¿›è¡Œè®¿é—®æ§åˆ¶çš„è¿‡æ»¤å™¨ä¹‹ä¸€ï¼Œå®ƒä¸»è¦ç”¨äºå¯¹è¯·æ±‚è¿›è¡Œæƒé™éªŒè¯å’Œè®¿é—®æ§åˆ¶ã€‚å½“ç”¨æˆ·å‘é€è¯·æ±‚æ—¶ï¼Œ<code>FilterSecurityInterceptor</code>ä¼šæ‹¦æˆªè¯¥è¯·æ±‚ï¼Œå¹¶æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ï¼š</p><ol><li>æƒé™éªŒè¯ï¼šæ ¹æ®è¯·æ±‚çš„è·¯å¾„å’Œç”¨æˆ·çš„æƒé™ä¿¡æ¯ï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å…·æœ‰è®¿é—®è¯¥èµ„æºçš„æƒé™ã€‚</li><li>è®¿é—®æ§åˆ¶å†³ç­–ï¼šæ ¹æ®é…ç½®çš„æƒé™æ§åˆ¶è§„åˆ™ï¼Œå†³å®šæ˜¯å¦å…è®¸ç”¨æˆ·è®¿é—®è¯·æ±‚çš„èµ„æºã€‚</li><li>å¼‚å¸¸å¤„ç†ï¼šåœ¨æƒé™éªŒè¯å¤±è´¥æˆ–è®¿é—®è¢«æ‹’ç»æ—¶ï¼Œ<code>FilterSecurityInterceptor</code> è´Ÿè´£æŠ›å‡ºç›¸åº”çš„å¼‚å¸¸æˆ–æ‰§è¡Œå…¶ä»–å®šä¹‰çš„å¼‚å¸¸å¤„ç†é€»è¾‘ã€‚</li></ol><p>é€šè¿‡åˆç†é…ç½® <code>FilterSecurityInterceptor</code>ï¼Œå¯ä»¥å®ç°å¯¹ç³»ç»Ÿä¸­å„ç§èµ„æºçš„æƒé™æ§åˆ¶ï¼Œç¡®ä¿åªæœ‰å…·æœ‰ç›¸åº”æƒé™çš„ç”¨æˆ·æ‰èƒ½è®¿é—®ç‰¹å®šçš„åŠŸèƒ½æˆ–æ•°æ®ã€‚</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain chain) throws ServletException, IOException {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        HttpServletRequest request </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (HttpServletRequest)servletRequest;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        HttpServletResponse response </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (HttpServletResponse)servletResponse;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 1. å¦‚æœè®¾ç½®äº†ç›‘æ§æ¯ä¸€æ¬¡è¯·æ±‚ï¼Œå¹¶ä¸”å½“å‰è¿‡æ»¤å™¨å·²ç»æ‰§è¡Œï¼Œåˆ™ç›´æ¥è·³è¿‡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.observeOncePerRequest </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isApplied</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            chain.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">skipDispatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        	// 2. å¦‚æœæ˜¯è®¿é—®é”™è¯¯é¡µé¢ï¼Œåˆ™ç›´æ¥è·³è¿‡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            chain.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 3. è®¾ç½®å·²æ‰§è¡Œå½“å‰è¿‡æ»¤å™¨ </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// org.springframework.security.web.access.intercept.AuthorizationFilter@5707f613.APPLIED</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            String alreadyFilteredAttributeName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getAlreadyFilteredAttributeName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            request.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setAttribute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(alreadyFilteredAttributeName, Boolean.TRUE);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            	// 4. è°ƒç”¨AuthorizationManager æ£€æŸ¥å½“å‰æ˜¯å¦æœ‰æƒé™</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                AuthorizationDecision decision </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.authorizationManager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">getAuthentication, request);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // 5. å‘å¸ƒæˆæƒäº‹ä»¶</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.eventPublisher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">publishAuthorizationEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">getAuthentication, request, decision);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // 6. å¦‚æœæœªè¢«æˆæƒï¼ŒæŠ›å‡º AccessDeniedException</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (decision </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">decision.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isGranted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                    throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AccessDeniedException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Access Denied&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                chain.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                request.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">removeAttribute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(alreadyFilteredAttributeName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span></code></pre></div><h2 id="_4-æµç¨‹åˆ†æ" tabindex="-1">4.æµç¨‹åˆ†æ <a class="header-anchor" href="#_4-æµç¨‹åˆ†æ" aria-label="Permalink to &quot;4.æµç¨‹åˆ†æ&quot;">â€‹</a></h2><p>ä¸Šé¢æˆ‘ä»¬ä»‹ç»äº†è¿™ä¹ˆå¤šçš„è¿‡æ»¤å™¨ä»¥åŠè¿›è¡Œäº†ç®€å•çš„åˆ†æï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æˆ‘ä»¬éœ€è¦æ³¨æ„ï¼Œæ—¢ç„¶é¡¹ç›®å¯åŠ¨åˆå§‹åŒ–åä¼šåˆè¯†åŒ–è¿™äº›è¿‡æ»¤å™¨ï¼Œé‚£ä¹ˆæ˜¯è°æ¥è¿›è¡Œæ‰§è¡Œè°ƒåº¦ä»–ä»¬å‘¢ï¼Ÿ</p><p>ä¹‹å‰æˆ‘ä»¬äº†è§£è¿‡<code>FilterChainProxy </code>æ˜¯ <code>SpringSecurity </code>ä½¿ç”¨çš„æ ¸å¿ƒï¼Œç”¨äºä»£ç†<code>SpringSecurity</code>ä¸­æ‰€æœ‰çš„<code>SecurityFilterChain </code>ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„è¿‡æ»¤å™¨ï¼Œé€šè¿‡<code>DelegatingFilterProxy </code>è¿›è¡Œä»£ç†ã€‚</p><p><code>FilterChainProxy</code>ç»§æ‰¿è‡ª<code>GenericFilterBean</code>ç±»ã€‚</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FilterChainProxy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(List</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SecurityFilterChain</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> filterChains) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	 // ä¸Šä¸‹æ–‡æŒæœ‰è€…ï¼ˆå½“å‰è®¤è¯ä¸»ä½“ä¸€äº›ä¿¡æ¯ï¼‰ç­–ç•¥ï¼Œé»˜è®¤ï¼šThreadLocal</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	 this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.securityContextHolderStrategy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SecurityContextHolder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getContextHolderStrategy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	 // è¿‡æ»¤å™¨é“¾æ ¡éªŒ</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 	this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.filterChainValidator </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> NullFilterChainValidator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	 // Httpé˜²ç«å¢™</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	 this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.firewall </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> StrictHttpFirewall</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	 // è¯·æ±‚è¢«æ‹’ç»å¤„ç†ç¨‹åº</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	 this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.requestRejectedHandler </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HttpStatusRequestRejectedHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	 // å¼‚å¸¸è§£æå™¨</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	 this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.throwableAnalyzer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ThrowableAnalyzer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	 // è™šæ‹Ÿçš„è¿‡æ»¤å™¨é“¾è£…é¥°å™¨</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	 this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.filterChainDecorator </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VirtualFilterChainDecorator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	 // Security è¿‡æ»¤å™¨é“¾é›†åˆï¼Œé»˜è®¤åªæœ‰ä¸€ä¸ªDefaultSecurityFilterChain</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	 this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.filterChains </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> filterChains;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span></code></pre></div><p>é‚£ä¹ˆä»–ä»¬çš„æ•´ä¸ªçš„<strong>æ‰§è¡Œæµç¨‹</strong>æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Œæˆ‘ä»¬æ¥ç®€å•åˆ†æä¸€ä¸‹ã€‚</p><p><img src="https://gaoziman.oss-cn-hangzhou.aliyuncs.com/Leo100/202311080959111.png" alt="image-20231108095916877"></p><p>åœ¨<code>doFilterInternal</code>æ–¹æ³•ä¸­<code>Spring Security </code>é˜²ç«å¢™ä¼šè¿›è¡Œç¬¬ä¸€æ­¥è¯·æ±‚æ ¡éªŒï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> doFilterInternal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			throws IOException, ServletException {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 1. é˜²ç«å¢™æ ¡éªŒï¼Œå°†è¯·æ±‚å’Œå“åº”è¿›è¡ŒåŒ…è£…</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 1.1 è¯·æ±‚æ–¹å¼æ˜¯å¦è¢«å…è®¸</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 1.2 URL æ˜¯å¦è§„èŒƒ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 1.3 è¿œç¨‹IPæ˜¯å¦é»‘åå•</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 1.4 æ‹’ç»å­—æ®µåç§°ä¸­çš„ä¸å¯æ‰“å°Asciiå­—ç¬¦</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 1.5 è¯·æ±‚å¯¹è±¡æ˜¯å¦è§„èŒƒ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		FirewalledRequest firewallRequest </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.firewall.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getFirewalledRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((HttpServletRequest) request);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		HttpServletResponse firewallResponse </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.firewall.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getFirewalledResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((HttpServletResponse) response);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// å–å‡ºæ‰€æœ‰è¿‡æ»¤å™¨é“¾ä¸­çš„æ‰€æœ‰è¿‡æ»¤å™¨</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; filters </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getFilters</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(firewallRequest);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		FilterChain reset </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (req, res) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isDebugEnabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">debug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LogMessage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Secured &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> requestLine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(firewallRequest)));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// Deactivate path stripping as we exit the security filter chain</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			firewallRequest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			chain.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(req, res);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		};</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// å¯¹è¿‡æ»¤å™¨é“¾è¿›è¡Œè£…é¥°ï¼Œå¹¶è°ƒç”¨è£…é¥°ç±»çš„doFilter æ–¹æ³•</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">		this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.filterChainDecorator.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">decorate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(reset, filters).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(firewallRequest, firewallResponse);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span></code></pre></div><p>åœ¨è£…é¥°è¿‡æ»¤å™¨é“¾<code>VirtualFilterChain</code>ä¸­ï¼Œå¼€å§‹æ­£å¼è°ƒç”¨<code>Spring Security </code>ä¸­çš„è¿‡æ»¤å™¨ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ServletRequest request, ServletResponse response) throws IOException, ServletException {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 1. å½“å‰è¢«è°ƒç”¨è¿‡æ»¤å™¨çš„ä½ç½®ï¼ˆåˆå§‹å€¼ä¸º0ï¼‰æ˜¯å¦ç­‰äºè¿‡æ»¤å™¨æ•°é‡ï¼ˆé»˜è®¤15ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.currentPosition </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.size) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// ä½ç½®å˜ä¸ºè¿‡æ»¤å™¨æ•°é‡å¤§å°æ—¶ï¼Œè¯´æ˜å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ï¼Œè°ƒç”¨è¿‡æ»¤å™¨é“¾æ‰§è¡Œè¿‡æ»¤å™¨ï¼ˆä¸å†æ˜¯Spring Security ä¸­çš„è¿‡æ»¤å™¨äº†ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">				this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.originalChain.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 2. ä½ç½®åŠ 1</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">			this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.currentPosition</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 3. è·å–å½“å‰è¿‡æ»¤å™¨</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			Filter nextFilter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.additionalFilters.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.currentPosition </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isTraceEnabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				String name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nextFilter.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getSimpleName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">trace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LogMessage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Invoking %s (%d/%d)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, name, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.currentPosition, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.size));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 4. æ‰§è¡Œè¿‡æ»¤å™¨</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			nextFilter.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, response, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>SpringSecurity </code>ä¸­çš„è¿‡æ»¤å™¨æ‰§è¡Œï¼Œæ˜¯ä¸¥æ ¼æŒ‰ç…§é¡ºåºè¢«è°ƒç”¨çš„ã€‚æ¯ä¸ªè¿‡æ»¤å™¨æœ‰åºæ‰§è¡Œï¼Œå®Œæˆå„è‡ªçš„åŠŸèƒ½ï¼Œæ‰€æœ‰çš„è¿‡æ»¤å™¨éƒ½é€šè¿‡åï¼Œè¿›å…¥<code>Servlet</code>ï¼Œæ§åˆ¶å±‚æ¥æ”¶åˆ°è¯·æ±‚è¿›è¡Œä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œæœ€ç»ˆå“åº”å¯¹è±¡åˆç»è¿‡æ¯ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><h2 id="_5-å‚è€ƒæ–‡çŒ®" tabindex="-1">5.å‚è€ƒæ–‡çŒ® <a class="header-anchor" href="#_5-å‚è€ƒæ–‡çŒ®" aria-label="Permalink to &quot;5.å‚è€ƒæ–‡çŒ®&quot;">â€‹</a></h2><ul><li><a href="https://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Spring%20Security%20%E8%AF%A6%E8%A7%A3%E4%B8%8E%E5%AE%9E%E6%93%8D/08%20%20%E7%AE%A1%E9%81%93%E8%BF%87%E6%BB%A4%EF%BC%9A%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E%20Spring%20Security%20%E8%BF%87%E6%BB%A4%E5%99%A8%E6%89%A9%E5%B1%95%E5%AE%89%E5%85%A8%E6%80%A7%EF%BC%9F.md" target="_blank" rel="noreferrer">https://learn.lianglianglee.com/ä¸“æ /Spring Security è¯¦è§£ä¸å®æ“/08 ç®¡é“è¿‡æ»¤ï¼šå¦‚ä½•åŸºäº Spring Security è¿‡æ»¤å™¨æ‰©å±•å®‰å…¨æ€§ï¼Ÿ.md</a></li><li><a href="https://www.processon.com/diagraming/6547a0f554338f0b199d353c" target="_blank" rel="noreferrer">https://www.processon.com/diagraming/6547a0f554338f0b199d353c</a></li><li><a href="https://springdoc.cn/spring-security/servlet/architecture.html" target="_blank" rel="noreferrer">https://springdoc.cn/spring-security/servlet/architecture.html</a></li></ul><h2 id="_6-æ€»ç»“" tabindex="-1">6.æ€»ç»“ <a class="header-anchor" href="#_6-æ€»ç»“" aria-label="Permalink to &quot;6.æ€»ç»“&quot;">â€‹</a></h2><p>ä»¥ä¸Šä¾¿æ˜¯æœ¬æ–‡çš„å…¨éƒ¨å†…å®¹ï¼Œæœ¬äººæ‰ç–å­¦æµ…ï¼Œæ–‡ç« æœ‰ä»€ä¹ˆé”™è¯¯çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§ä½¬ä»¬æ‰¹è¯„æŒ‡æ­£ï¼æˆ‘æ˜¯<strong>Leo</strong>ï¼Œä¸€ä¸ªåœ¨äº’è”ç½‘è¡Œä¸šçš„å°ç™½ï¼Œç«‹å¿—æˆä¸ºæ›´å¥½çš„è‡ªå·±ã€‚</p><p>å¦‚æœä½ æƒ³äº†è§£æ›´å¤šå…³äº<strong>Leo</strong>ï¼Œå¯ä»¥å…³æ³¨å…¬ä¼—å·-ç¨‹åºå‘˜Leoï¼Œåé¢æ–‡ç« ä¼šé¦–å…ˆåŒæ­¥è‡³å…¬ä¼—å·ã€‚</p>`,185)]))}const o=i(e,[["render",l]]);export{g as __pageData,o as default};
